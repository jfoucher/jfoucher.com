<!DOCTYPE html> 
<html lang="en">
<!--
	Access keys:
		H = homepage
		S = search input field
		L = latest article on the homepage
		A = about page
-->
<head>
    <title>
        Import contacts from Google by entering your email and password
        
    </title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="author" content="Jonathan Foucher" />
	<meta name="designer" content="Jonathan Foucher" />
	<meta name="developer" content="Jonathan Foucher" />
	<meta name="description" content="In some sites like for example Dropbox, you invite people from your Gmail contacts by simply entering your email and password: this is how it's done" />
	<meta name="keywords" content="Web development, france, wordpress, codeigniter, linux, ubuntu, debian, system administration" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<link rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/en/" />
    <link href="http://tent.jfoucher.com/profile" rel="https://tent.io/rels/profile" />
    <link href='http://fonts.googleapis.com/css?family=Questrial' rel='stylesheet' type='text/css'>
	<!--<link rel="stylesheet" href="/assets/css/screen.css" type="text/css" media="screen" />-->

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>

	<script type="text/javascript" src="/assets/js/app.js"></script>
    <link rel="stylesheet" href="/assets/css/screen.css" type="text/css" media="screen" />
    <!--[if lt IE 9]>
    <script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <script type="text/javascript" src="http://www.shrinktheweb.com/scripts/pagepix.js"></script>
	<link rel="alternate" href="http://feeds.feedburner.com/GeekyNuggets" title="Geeky Nuggets" type="application/atom+xml" />

	<link rel="shortcut icon" type="image/png" href="/favicon.png" />

</head>
<body>


	<div id="container" class="clearfix">
		                <header id="header" class="center">
            <div class="logo">
                <a href="/" title="Return to homepage" tabindex="0" accesskey="H">
                    Geeky Nuggets
                </a>
            </div>
            <div class="siteDesc"><a href="/about.html" title="About Jonathan Foucher
                &amp; contact details" tabindex="0" accesskey="A">Jonathan Foucher</a>&rsquo;s blog <span
                class="amp">&amp;</span> web development
                notebook.
            </div>
                    <nav id="nav" class="clear">
            <ul class="nav nav-header caps">
				<li><a href="/about.html" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
				<li class="active"><a href="/archives.html" title="View the blog archives" tabindex="0">Archives</a></li>

				<li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Subscribe to my posts, by email or in your feed reader" tabindex="0">Feed</a></li>
            </ul>
			<div class="sitesearch">

                <!-- Google Custom Search Element -->
                <!-- <form action="http://www.google.com/cse" class="center_column" id="searchForm" >
                    <fieldset>
                       <input type="hidden" name="cx" value="004905032692135561336:flcwnz7i1ww" />
                       <input type="hidden" name="ie" value="UTF-8" />
                       <label for="search" class="hidden">Search</label>
                       <input id="search" class="text-input" type="text" name="q" size="15" tabindex="0" accesskey="S" />
                       <input id="searchsubmit" type="submit" name="sa" value="Search" tabindex="0" />
                    </fieldset>
                </form>-->

            </div>

        </nav> <!-- /#nav.clear -->


            
		</header> <!-- /#header.center -->


		<div id="notebook" class="center clear">
			<div class="page-nav-top">
                
				    <span class="page-nav-item page-prev"><a class="internal" rel="prev"  href="/2012/04/github-tricks-from-stackoverflow.html" title="View Git tips from stackoverflow">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item page-next"><a class="internal" rel="next"  href="/2012/04/installing-apache-php-and-nginx-for-faster-websites.html" title="View Installing PHP, Apache2 and nginx for faster websites">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-top -->

             <h2 class="post-title">
                <a href="/2012/04/getting-your-users-gmail-contacts.html" title="Permanent link to Import contacts from Google by entering your email and password">
                    Import contacts from Google by entering your email and password
                </a>
            </h2>

            <div class="meta">
                <div class="hero">

                    <p>
                        In some sites like for example Dropbox, you invite people from your Gmail contacts by simply entering your email and password: this is how it's done
                    </p>
                </div>
                <!-- <span class="pdf">Download a <a href="/2012/04/getting-your-users-gmail-contacts.html.pdf" title="Download a PDF, printer-friendly copy of this article"><acronym title="Portable Document Format">PDF</acronym>, printer-friendly version of this article</a>.</span> -->
                <span class="permalink">For referencing: <a href="/2012/04/getting-your-users-gmail-contacts.html" title="[Permalink] Import contacts from Google by entering your email and password">permalink to this article</a>.</span>
                    <span class="date" title="Sun Apr 15 09:17:07 +0200 2012">
                    <span class="published">Published&thinsp;&bull;</span>
                    <span class="day">15</span>
                    <span class="month"><abbr>Apr</abbr></span>
                    <span class="year">2012</span>
                </span>
                <div class="share">
                    <div class="iframes">
                        <a href="https://twitter.com/share" class="twitter-share-button" data-via="jfoucher">Tweet</a>
                        
<iframe scrolling="no" height="28px" width="115px" src="http://hnlike.com/upvote.php?link=http%3A%2F%2Fjfoucher.com/2012/04/getting-your-users-gmail-contacts.html&amp;title=Import contacts from Google by entering your email and password">
    <a href="http://hnlike.com/upvote.php?link=http%3A%2F%2Fjfoucher.com/2012/04/getting-your-users-gmail-contacts.html&amp;title=Import contacts from Google by entering your email and password">upvote on HN</a>
</iframe>


                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    </div>
                </div>
            </div> <!-- /.meta -->
            <div id="entry-content">

                <p>This is what google calls the <a href='https://developers.google.com/accounts/docs/AuthForInstalledApps#Using'>ClientLogin</a> method of authentication. It allow your user to simply input their username and password and see a list of their contacts displayed, where they can select which ones to invite, in this case.</p>

<p>The way to do that is pretty easy, first we have to make a POST request to google to get an authentification token for the subsequent authenticated requests. I chose to use the <a href='https://github.com/kriswallsmith/Buzz'>Buzz PHP library</a> as my HTTP client. It makes everything easy and removes the necessity of countless <code>curl_set_opts()</code>. Buzz requires PHP 5.3, but I&#8217;m using Symfony2 which also does, so that&#8217;s not a problem, actually more of a boon as I find PHP5.3 code generally cleaner.</p>

<p>I created a class <code>Importer</code> with a protected variable <code>$browser</code> which is the Buzz\Browser instance we&#8217;ll be using to connect to google. Google returns the data in a line based format, so I used a little helper function to convert it to a PHP array:</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
    <span class='k'>protected</span> <span class='k'>function</span> <span class='nf'>unserializeGoogleData</span><span class='p'>(</span><span class='nv'>$data</span><span class='p'>){</span>
        <span class='nv'>$returns</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>();</span>
        <span class='k'>foreach</span> <span class='p'>(</span><span class='nb'>explode</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>,</span><span class='nv'>$data</span><span class='p'>)</span> <span class='k'>as</span> <span class='nv'>$line</span><span class='p'>)</span>
        <span class='p'>{</span>
            <span class='nv'>$line</span> <span class='o'>=</span> <span class='nx'>trim</span><span class='p'>(</span><span class='nv'>$line</span><span class='p'>);</span>
            <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='nv'>$line</span><span class='p'>)</span> <span class='k'>continue</span><span class='p'>;</span>
            <span class='k'>list</span><span class='p'>(</span><span class='nv'>$k</span><span class='p'>,</span><span class='nv'>$v</span><span class='p'>)</span> <span class='o'>=</span> <span class='nb'>explode</span><span class='p'>(</span><span class='s2'>&quot;=&quot;</span><span class='p'>,</span><span class='nv'>$line</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>);</span>
            <span class='nv'>$returns</span><span class='p'>[</span><span class='nv'>$k</span><span class='p'>]</span> <span class='o'>=</span> <span class='nv'>$v</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>return</span> <span class='nv'>$returns</span><span class='p'>;</span>
    <span class='p'>}</span>
<span class='cp'>?&gt;</span><span class='x' />
</code></pre></div>
<p>So first we need to get the auth token from google:</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
<span class='nv'>$params</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>(</span>
    <span class='s1'>&#39;accountType&#39;</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;HOSTED_OR_GOOGLE&#39;</span><span class='p'>,</span>
    <span class='s1'>&#39;Email&#39;</span> <span class='o'>=&gt;</span> <span class='nv'>$data</span><span class='p'>[</span><span class='s1'>&#39;email&#39;</span><span class='p'>],</span>
    <span class='s1'>&#39;Passwd&#39;</span> <span class='o'>=&gt;</span> <span class='nv'>$data</span><span class='p'>[</span><span class='s1'>&#39;password&#39;</span><span class='p'>],</span>
    <span class='s1'>&#39;service&#39;</span><span class='o'>=&gt;</span> <span class='s1'>&#39;cp&#39;</span><span class='p'>,</span>
    <span class='s1'>&#39;source&#39;</span><span class='o'>=&gt;</span> <span class='s1'>&#39;mention-web-1.0&#39;</span><span class='p'>,</span>
<span class='p'>);</span>
<span class='nv'>$output</span> <span class='o'>=</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>browser</span><span class='o'>-&gt;</span><span class='na'>post</span><span class='p'>(</span><span class='s1'>&#39;https://www.google.com/accounts/ClientLogin&#39;</span><span class='p'>,</span>
    <span class='k'>array</span><span class='p'>(),</span>
    <span class='nb'>http_build_query</span><span class='p'>(</span><span class='nv'>$params</span><span class='p'>));</span>

<span class='nv'>$returns</span> <span class='o'>=</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>unserializeGoogleData</span><span class='p'>(</span><span class='nv'>$output</span><span class='o'>-&gt;</span><span class='na'>getContent</span><span class='p'>());</span>
<span class='cp'>?&gt;</span><span class='x' />
</code></pre></div>
<p>Where <code>$data[&#39;email&#39;]</code> and <code>$data[&#39;password&#39;]</code> are the user&#8217;s email and password, respectively.</p>

<p>If everything went fine, the <code>$returns</code> variable now contains an associative array with a key <code>Auth</code>, so we can proceed with the next step, actually getting the contacts:</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
    <span class='k'>if</span><span class='p'>(</span><span class='nb'>isset</span><span class='p'>(</span><span class='nv'>$returns</span><span class='p'>[</span><span class='s1'>&#39;Auth&#39;</span><span class='p'>]))</span> <span class='p'>{</span>

        <span class='nv'>$feed_url</span> <span class='o'>=</span> <span class='s2'>&quot;https://www.google.com/m8/feeds/contacts/&quot;</span> <span class='o'>.</span>
            <span class='nb'>urlencode</span><span class='p'>(</span><span class='nv'>$data</span><span class='p'>[</span><span class='s1'>&#39;email&#39;</span><span class='p'>])</span> <span class='o'>.</span>
            <span class='s2'>&quot;/full?alt=json&amp;max-results=500&quot;</span><span class='p'>;</span>


        <span class='nv'>$header</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>(</span>
            <span class='s1'>&#39;Authorization: GoogleLogin auth=&#39;</span> <span class='o'>.</span> <span class='nv'>$returns</span><span class='p'>[</span><span class='s1'>&#39;Auth&#39;</span><span class='p'>],</span>
        <span class='p'>);</span>

        <span class='nv'>$result</span> <span class='o'>=</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>browser</span><span class='o'>-&gt;</span><span class='na'>get</span><span class='p'>(</span><span class='nv'>$feed_url</span><span class='p'>,</span> <span class='nv'>$header</span><span class='p'>);</span>


        <span class='nv'>$r</span> <span class='o'>=</span> <span class='nb'>json_decode</span><span class='p'>(</span><span class='nv'>$result</span><span class='o'>-&gt;</span><span class='na'>getContent</span><span class='p'>(),</span> <span class='k'>true</span><span class='p'>);</span>
        <span class='c1'>//return $r;</span>
        <span class='nv'>$results</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>();</span>
        <span class='k'>if</span><span class='p'>(</span><span class='nb'>isset</span><span class='p'>(</span><span class='nv'>$r</span><span class='p'>[</span><span class='s1'>&#39;feed&#39;</span><span class='p'>][</span><span class='s1'>&#39;entry&#39;</span><span class='p'>])</span> <span class='o'>&amp;&amp;</span> <span class='o'>!</span><span class='k'>empty</span><span class='p'>(</span><span class='nv'>$r</span><span class='p'>[</span><span class='s1'>&#39;feed&#39;</span><span class='p'>][</span><span class='s1'>&#39;entry&#39;</span><span class='p'>])){</span>
            <span class='nv'>$results</span> <span class='o'>=</span> <span class='nb'>array_map</span><span class='p'>(</span><span class='k'>function</span><span class='p'>(</span><span class='nv'>$el</span><span class='p'>){</span>
                <span class='nv'>$r</span><span class='o'>=</span><span class='k'>array</span><span class='p'>();</span>
                <span class='k'>if</span><span class='p'>(</span><span class='nb'>isset</span><span class='p'>(</span><span class='nv'>$el</span><span class='p'>[</span><span class='s1'>&#39;gd$email&#39;</span><span class='p'>])){</span>
                    <span class='nv'>$r</span><span class='p'>[</span><span class='s1'>&#39;email&#39;</span><span class='p'>]</span> <span class='o'>=</span> <span class='nv'>$el</span><span class='p'>[</span><span class='s1'>&#39;gd$email&#39;</span><span class='p'>][</span><span class='mi'>0</span><span class='p'>][</span><span class='s1'>&#39;address&#39;</span><span class='p'>];</span>
                    <span class='k'>if</span> <span class='p'>(</span><span class='nb'>isset</span><span class='p'>(</span><span class='nv'>$el</span><span class='p'>[</span><span class='s1'>&#39;title&#39;</span><span class='p'>][</span><span class='s1'>&#39;$t&#39;</span><span class='p'>])){</span>
                        <span class='nv'>$r</span><span class='p'>[</span><span class='s1'>&#39;name&#39;</span><span class='p'>]</span> <span class='o'>=</span> <span class='nv'>$el</span><span class='p'>[</span><span class='s1'>&#39;title&#39;</span><span class='p'>][</span><span class='s1'>&#39;$t&#39;</span><span class='p'>];</span>
                    <span class='p'>}</span>
                <span class='p'>}</span>

                <span class='k'>return</span> <span class='nv'>$r</span><span class='p'>;</span>
            <span class='p'>},</span> <span class='nv'>$r</span><span class='p'>[</span><span class='s1'>&#39;feed&#39;</span><span class='p'>][</span><span class='s1'>&#39;entry&#39;</span><span class='p'>]);</span>
        <span class='p'>}</span>
        <span class='k'>return</span> <span class='nv'>$results</span>

    <span class='p'>}</span><span class='k'>else</span><span class='p'>{</span>
        <span class='k'>return</span> <span class='k'>false</span><span class='p'>;</span>
    <span class='p'>}</span>
</code></pre></div>
<p>If the user and password were incorrect, the <code>Auth</code> key will not be present in the array, and so we simply return <code>false</code>. It is recommended to see if Google requires the user to solve a catcha, in which case it should be displayed. But as that was not necessary in this case, it will be left as an exercise for the reader. On the other hand, if everything was ok, the <code>$results</code> array is now populated with the user&#8217;s contacts, so the next step is to walk over the array extracting the data we need, in this case only the main email and the full name of the contact. We populate an array with the required data and simply return it for the caller to use.</p>

<p>I hope this will be useful to someone, but please note that Google <a href='https://developers.google.com/accounts/docs/AuthForInstalledApps'>recommends</a> you use OAuth for that kind of things.</p>



                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'geekynuggets'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            </div> <!-- /.entry-content.colEight -->
            <div class="page-nav-bottom">
                
				    <span class="page-nav-item page-prev"><a class="internal" rel="prev"  href="/2012/04/github-tricks-from-stackoverflow.html#notebook" title="Read Git tips from stackoverflow">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item page-next"><a class="internal" rel="next"  href="/2012/04/installing-apache-php-and-nginx-for-faster-websites.html#notebook" title="Read Installing PHP, Apache2 and nginx for faster websites">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-bottom -->
        </div> <!-- /#notebook.center.clear -->
            <footer id="footer" class="clear">
        <span class="backtop"><a class="internal" href="#header" title="Return to the top of this page">Back to top &uarr;</a></span>
        <nav>
            <ul id="nav-footer">
                <li><a href="/about.html" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
                <li><a href="/archives.html" title="View the blog archives" tabindex="0">Archives</a></li>

                <li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Feed link" tabindex="0">Feed</a></li>
            </ul>
        </nav>

        <div class="page-meta clear">
            <div class="info">

                <p class="copyright ">
                    This blog has been online in one form or another since
                    <span class="date" title="March 2004">2004</span><br />Copyright &copy; <a href="http://jfoucher.com">Jonathan
                    Foucher.</a><br /><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"
                       title="You can use this for non-comercial purposes, provided you cite me as the author, and do not modify the content">
                        Creative Commons License
                    </a>
                    <br />
                    <a href="/jfoucher-6px.eu.asc">GPG Key</a>
                </p>
            </div>

        </div> <!-- /.page-meta.clear -->
    </footer> <!-- /#footer.center.clear -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8465441-2']);
    _gaq.push(['_trackPageview']);



    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
        '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();


    var docHeight = document.height,
    vscroll = $(document).scrollTop();

    $(document).bind('scroll', function(){
        var docHeight = document.height,
                vscroll = $(document).scrollTop();

        if(vscroll > docHeight / 2) {
            $(document).unbind('scroll');
            _gaq.push(['_trackEvent', 'scrolled_half', 'read']);
            console.log('not a bounce')
        }
    });

    </script>

    <script type="text/javascript">
        var clicky_site_ids = clicky_site_ids || [];
        clicky_site_ids.push(100617617);
        (function() {
            var s = document.createElement('script');
            s.type = 'text/javascript';
            s.async = true;
            s.src = '//static.getclicky.com/js';
            ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
        })();
    </script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100617617ns.gif" /></p></noscript>
</body>
</html>
	</div>
