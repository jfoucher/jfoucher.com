<!DOCTYPE html> 

<html lang="en">

<!-- 
	Access keys:
		H = homepage
		S = search input field
		L = latest article on the homepage
		F = portfolio
		A = about page
		
		N = next portfolio preview item
		P = previous prtoflio preview item
-->
<head>
    <title>Organize Series plugin database optimization</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta http-equiv="content-language" content="en" />
	<meta name="author" content="Jonathan Foucher" />
	<meta name="designer" content="Jonathan Fouch" />
	<meta name="developer" content="Jonathan Foucher" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<meta name="robots" content="noydir, noopd" /> <!-- Opt out of ODP -->

	<link rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/en/" />
	<link rel="stylesheet/less" href="/assets/css/screen.less" type="text/css" media="screen" />
	<link rel="stylesheet" href="/assets/css/print.css" type="text/css" media="print" />

	<link rel="alternate" href="http://feeds.feedburner.com/GeekyNuggets" title="Geeky Nuggets" type="application/atom+xml" />
	
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="/assets/js/less-1.1.4.js" type="text/javascript"></script>
    <script src="/assets/js/jquery.timeago.js" type="text/javascript"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8465441-2']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
        '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    </script>
</head>

<body>
	<div id="container" class="clearfix">
		                <div id="header" class="center">
            <div class="article-logo">
                <h1>
				    <a href="/" title="Return to homepage" tabindex="0" accesskey="H">
				        <span class="hoverline">Geeky Nuggets</span>
				    </a>
                </h1>
            </div>
            <div class="hero">
                <p class="moin">
                    
                    You&#8217;re currently viewing a single article. Feel free to skip back to
                    <a href="/" rel="home" title="Go back to the homepage" tabindex="0">&sect; Index</a> or straight to
                    <a href="/#notebook" title="Skip straight to the latest article" tabindex="0" accesskey="L">&sect; Latest article</a>.
                </p>
                <p>
                    
                </p>
			</div>
		</div> <!-- /#header.center -->
		        <div id="nav" class="clear">
            <ul class="nav nav-header caps">
				<li><a href="/about.html#notebook" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
				<li><a href="/archives.html#cover" title="View the blog archives" tabindex="0">Archives</a></li>
				<li><a href="http://jfoucher.fr" title="Go to the portfolio" tabindex="0">Portfolio</a></li>
				<li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Feed link" tabindex="0">Feed</a></li>
            </ul>
			<div class="sitesearch floatRight">
                <div class="sitesearch">
                    <!-- Google Custom Search Element -->
                    <form action="http://www.google.com/cse" class="center_column" />
                    <fieldset>
                       <input type="hidden" name="cx" value="004905032692135561336:flcwnz7i1ww" />
                       <input type="hidden" name="ie" value="UTF-8" />
                       <input id="search" class="text-input" type="text" name="q" size="15" tabindex="0" accesskey="S" />
                       <input id="searchsubmit" type="submit" name="sa" value="Search" tabindex="0" />
                    </fieldset>
                </div>
            </div>
			<div class="clear"></div>
        </div> <!-- /#nav.clear -->

		<div id="notebook" class="center clear">
			<div class="page-nav-top">
                
				    <span class="page-nav-item floatLeft"><a class="internal" rel="prev"  href="/2009/05/amazon-wishlist-plugin-for-wordpress-27.html#notebook" title="View Amazon Wishlist plugin for wordpress 2.7">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item floatRight"><a class="internal" rel="next"  href="/2009/06/auto-tag-wordpress-plugin.html#notebook" title="View Auto Tag Wordpress plugin">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-top -->

            <h2 class="clear">Organize Series plugin database optimization</h2>
            <span class="date" title="2009-05-19T09:56:50+02:00">
                <span class="published">Published&thinsp;&bull;</span>
                <span class="day">19</span>
                <span class="month"><abbr>May</abbr></span>
                <span class="year">2009</span>
            </span>
            <div id="entry-content">
                <p>While looking for posts in the series, this plugin makes two database queries for each post in the series : one to find out if the post is published, and another to get the part number in the series. So if you have 30 posts in the series, you will get 60 queries from this plugin alone on each post belonging to that series. I found this very wasteful, and rewrote one function so that it only uses one database query, no matter what the number of posts in the series. I think <a href="http://unfoldingneurons.com">the author</a> should be interested...</p>

<p>Basically, in the file series-utility.php, replace the function
function get_series_order($posts, $postid = 0, $skip = TRUE)
by the following one :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">get_series_order</span><span class="p">(</span><span class="nv">$posts</span><span class="p">,</span> <span class="nv">$postid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$skip</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$posts</span><span class="p">))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="c1">//don&#39;t have the posts array so can&#39;t do anything.</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span> <span class="nv">$posts</span> <span class="p">)</span>
  <span class="nv">$posts</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$posts</span><span class="p">);</span>

  <span class="nv">$series_posts</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="nv">$key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$spost</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">&#39;object_id&#39;</span><span class="p">,</span> <span class="nv">$posts</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$key</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
        <span class="nv">$spost_id</span> <span class="o">.=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="nv">$spost</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">];</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nv">$spost_id</span> <span class="o">.=</span> <span class="nv">$spost</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$key</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
        <span class="nv">$spost_id</span> <span class="o">.=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="nv">$spost</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nv">$spost_id</span> <span class="o">.=</span> <span class="nv">$spost</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$key</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//Optimized : 1 SQL query instead of 2* number ofposts in series//</span>
  <span class="nv">$results</span><span class="o">=</span><span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">get_results</span><span class="p">(</span><span class="s2">&quot;SELECT </span><span class="si">$wpdb-&gt;posts</span><span class="s2">.ID, </span><span class="si">$wpdb-&gt;postmeta</span><span class="s2">.meta_value</span>
<span class="s2">  FROM </span><span class="si">$wpdb-&gt;posts</span><span class="s2"> LEFT JOIN </span><span class="si">$wpdb-&gt;postmeta</span><span class="s2"></span>
<span class="s2">  ON(</span><span class="si">$wpdb-&gt;posts</span><span class="s2">.ID = </span><span class="si">$wpdb-&gt;postmeta</span><span class="s2">.post_id)</span>
<span class="s2">  WHERE post_status = &#39;publish&#39; AND </span><span class="si">$wpdb-&gt;posts</span><span class="s2">.ID</span>
<span class="s2">  IN (&quot;</span><span class="o">.</span><span class="nv">$spost_id</span><span class="o">.</span><span class="s2">&quot;) AND ener_postmeta.meta_key=&#39;&quot;</span><span class="o">.</span><span class="nx">SERIES_PART_KEY</span><span class="o">.</span><span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
  <span class="cm">/* 208 - fix by Matt Porter - to make sure unpublished posts are not made part of a series */</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$num</span><span class="o">=&gt;</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//echo &quot;&lt;h1&gt;resultat&quot;.$result-&gt;ID.$result&gt;meta_value.&quot;&lt;/h1&gt;&quot;;</span>
    <span class="nv">$series_posts</span><span class="p">[</span><span class="nv">$num</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="na">ID</span><span class="p">;</span>
    <span class="nv">$series_posts</span><span class="p">[</span><span class="nv">$num</span><span class="p">][</span><span class="s1">&#39;part&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">meta_value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$series_posts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">usort</span><span class="p">(</span> <span class="nv">$series_posts</span><span class="p">,</span> <span class="s1">&#39;_usort_series_by_part&#39;</span> <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$series_posts</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre>
</div>


<p>And there you go, a faster blog...While looking for posts in the series, this plugin makes two database queries for each post in the series : one to find out if the post is published, and another to get the part number in the series. So if you have 30 posts in the series, you will get 60 queries from this plugin alone on each post belonging to that series. I found this very wasteful, and rewrote one function so that it only uses one database query, no matter what the number of posts in the series. I think <a href="http://unfoldingneurons.com">the author</a> should be interested...</p>

<p>Basically, in the file series-utility.php, replace the function
function get_series_order($posts, $postid = 0, $skip = TRUE)
by the following one :</p>

<p>&lt;?php
function get_series_order($posts, $postid = 0, $skip = TRUE) {
global $wpdb;
if (!isset($posts)) return false; //don't have the posts array so can't do anything.</p>

<p>if ( !is_array( $posts )
$posts = array($posts);</p>

<p>$series_posts = array();
$key = 0;</p>

<p>foreach ($posts as $spost) {
if (array_key_exists('object_id', $posts)) {
if ($key!=0){
$spost_id .= ",".$spost['object_id'];
}else{
$spost_id .= $spost['object_id'];
}
} else {
if ($key!=0){
$spost_id .= ",".$spost;
}else{
$spost_id .= $spost;
}
}
$key++;
}</p>

<p>//Optimized : 1 SQL query instead of 2<em> number ofposts in series//
$results=$wpdb-&gt;get_results("SELECT $wpdb-&gt;posts.ID, $wpdb-&gt;postmeta.meta_value
FROM $wpdb-&gt;posts LEFT JOIN $wpdb-&gt;postmeta
ON($wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id)
WHERE post_status = 'publish' AND $wpdb-&gt;posts.ID
IN (".$spost_id.") AND ener_postmeta.meta_key='".SERIES_PART_KEY."'");
/</em> 208 - fix by Matt Porter - to make sure unpublished posts are not made part of a series */
foreach ($results as $num=&gt;$result) {
//echo "&lt;h1&gt;resultat".$result-&gt;ID.$result-&gt;meta_value."&lt;/h1&gt;";
$series_posts[$num]['id'] =$result-&gt;ID;
$series_posts[$num]['part'] = $result-&gt;meta_value;
}</p>

<p>if (count($series_posts) &gt; 1)
usort( $series_posts, '_usort_series_by_part' );</p>

<p>return $series_posts;
}
?&gt;</p>

<p>And there you go, a faster blog...</p>

                <div class="meta">
                    <!-- <span class="pdf">Download a <a href="/2009/05/organize-series-plugin-database-optimization.html.pdf" title="Download a PDF, printer-friendly copy of this article"><acronym title="Portable Document Format">PDF</acronym>, printer-friendly version of this article</a>.</span> -->
                    <span class="permalink">For referencing: <a href="/2009/05/organize-series-plugin-database-optimization.html" title="[Permalink] Organize Series plugin database optimization">permalink to this article</a>.</span>
                </div> <!-- /.meta -->
            </div> <!-- /.entry-content.colEight -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'geekynuggets'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

            <div class="page-nav-bottom">
                
				    <span class="page-nav-item floatLeft"><a class="internal" rel="prev"  href="/2009/05/amazon-wishlist-plugin-for-wordpress-27.html#notebook" title="View Amazon Wishlist plugin for wordpress 2.7">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item floatRight"><a class="internal" rel="next"  href="/2009/06/auto-tag-wordpress-plugin.html#notebook" title="View Auto Tag Wordpress plugin">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-bottom -->
        </div> <!-- /#notebook.center.clear -->
                <div id="footer" class="clear">
			<ul class="nav nav-footer caps">
				<li><a href="/about.html" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
				<li><a href="/archives.html#cover" title="View the blog archives" tabindex="0">Blog</a></li>
				<li><a href="http://jfoucher.fr" title="Go to the portfolio of Jonathan Foucher" tabindex="0">Portfolio</a></li>
				<li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Feed link" tabindex="0">Feed</a></li>
			</ul>
			<span class="backtop floatRight"><a class="internal" href="#header" title="Return to the top of this page">Back to top &uarr;</a></span>
			<div class="page-meta clear">
				<div class="info">
					<span class="index">&#9758;</span>
                    <p class="vcard">
                        <a href="/files/Simon-Pascal-Klein.vcf" title="Download Simon Pascal Klein&rsquo;s addressbook vCard">
                            Add me to your address book via vCard
                        </a>.
                    </p>
					<p class="copyright clear">
                        This blog has been online in one form or another since
                        <span class="date" title="March 2004">2004</span>&thinsp;&ndash;&thinsp;The first post was published
                    </p>
                    copyright &copy; Jonathan Foucher.
					<p class="licensing">
                        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"
                           title="You can use this for non-comercial purposes, provided you cite me as the author, and do not modify the content">
                            Some rights reserved
                        </a>.
                    </p>
					<p>For an overview of the site, see the <a href="/sitemap/" title="View the site map">site map</a> or <a href="/archives.html#cover" title="View the notebook archives">notebook archives</a>.</p>
					<h2>A playful tumble with <em>type</em>&hellip; &rarr;</h2>
					<p>&hellip;yes, <em>type</em>, not a graphic; try selecting it or resizing the page font size. Inspired by <a href="http://jontangerine.com/" title="jontangerine.com: Jon Tan&rsquo;s website">Jon Tan</a>&rsquo;s masterhead type folly, this is achieved just with some simple nested <code><span class="element">span</span></code> elements that are positioned absolutely against their relative parents, and the entire thing is sized in ems and scales nicely.</p>
				</div>
				<div class="type-folly">
					<em>Type
						<span>set
							<span>with
								<span>love
									<span>{
										<span>&hearts;
											<span>}</span>
										</span>
									</span>
								</span>
							</span>
						</span>
					</em>
					<strong>in
						<span>Georgia
							<span>&amp;
								<span>Museo</span>
							</span>
						</span>
					</strong>
					<span class="markup">&hellip;all in mostly valid <a rel="external" href="http://jigsaw.w3.org/css-validator/check/referer"><acronym title="Cascading Style Sheets">CSS</acronym></a> <span class="amp">&amp;</span> <a rel="external" href="http://validator.w3.org/check?uri=referer"><acronym title="eXtensible Hyper Text Markup Language">XHTML</acronym></a>; as <acronym title="plain old semantic (X)HTML">POSH</acronym> as can be.</span>
				</div>
			</div> <!-- /.page-meta.clear -->
		</div> <!-- /#footer.center.clear -->
	</div>
</body>
</html>
