<!DOCTYPE html> 

<html lang="en">

<!-- 
	Access keys:
		H = homepage
		S = search input field
		L = latest article on the homepage
		F = portfolio
		A = about page
		
		N = next portfolio preview item
		P = previous prtoflio preview item
-->
<head>
    <title>Organize Series plugin database optimization</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta http-equiv="content-language" content="en" />
	<meta name="author" content="Jonathan Foucher" />
	<meta name="designer" content="Jonathan Fouch" />
	<meta name="developer" content="Jonathan Foucher" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<meta name="robots" content="noydir, noopd" /> <!-- Opt out of ODP -->
	
	<link rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/en/" />
	<link rel="stylesheet" href="/assets/css/reset.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/assets/css/screen.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/assets/css/print.css" type="text/css" media="print" />
	
    <!-- <link rel="stylesheet" href="/css/syntax.css" type="text/css" media="screen" /> -->
	<link rel="alternate" href="http://feeds.feedburner.com/GeekyNuggets" title="Geeky Nuggets" type="application/atom+xml" />
	
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="/assets/js/jquery.timeago.js" type="text/javascript"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8465441-2']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
        '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    </script>
</head>

<body>
	<div id="container">
		                <div id="header" class="center">
            <div class="article-logo floatLeft">
                <h1>
				    <a href="/" title="Return to homepage" tabindex="0" accesskey="H">
				        <span class="hoverline">kle</span><span class="middot">&middot;</span>p<span class="hoverline">as</span>
				    </a>
                </h1>
            </div>
            <div class="hero floatRight colSix">
                <p class="moin">You&#8217;re currently viewing a single article. Feel free to skip back to <a href="/" rel="home" title="Go back to the homepage" tabindex="0">&sect; Index</a> or straight to <a href="/#notebook" title="Skip straight to the latest article" tabindex="0" accesskey="L">&sect; Latest article</a>.</p>
			</div>
		</div> <!-- /#header.center -->
		        <div id="nav" class="clear">
            <ul class="nav nav-header caps">
				<li><a href="/about.html#notebook" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
				<li><a href="/archives.html#cover" title="View the blog archives" tabindex="0">Archives</a></li>
				<li><a href="http://jfoucher.fr" title="Go to the portfolio" tabindex="0">Portfolio</a></li>
				<li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Feed link" tabindex="0">Feed</a></li>
            </ul>
			<div class="sitesearch floatRight">
                <div class="sitesearch">
                    <!-- Google Custom Search Element -->
                    <form action="http://www.google.com/cse" class="center_column" />
                    <fieldset>
                       <input type="hidden" name="cx" value="004905032692135561336:flcwnz7i1ww" />
                       <input type="hidden" name="ie" value="UTF-8" />
                       <input id="search" class="text-input" type="text" name="q" size="15" tabindex="0" accesskey="S" />
                       <input id="searchsubmit" type="submit" name="sa" value="Search" tabindex="0" />
                    </fieldset>
                </div>
            </div>
			<div class="clear"></div>
        </div> <!-- /#nav.clear -->

		<div id="notebook" class="center clear">
			<div class="page-nav-top">
                
				    <span class="page-nav-item floatLeft"><a class="internal" rel="prev"  href="/2009/05/19/amazon-wishlist-plugin-for-wordpress-27.html/#notebook" title="View Amazon Wishlist plugin for wordpress 2.7">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item floatRight"><a class="internal" rel="next"  href="/2009/06/04/auto-tag-wordpress-plugin.html/#notebook" title="View Auto Tag Wordpress plugin">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-top -->
            <div class="entry-content colEight">
                <h2 class="clear">Organize Series plugin database optimization</h2>
                <span class="date" title="2009-05-19T09:56:50+02:00">
                    <span class="published">Published&thinsp;&bull;</span>
                    <span class="day">19</span>
                    <span class="month"><abbr>May</abbr></span>
                    <span class="year">2009</span>
                </span>
                <p>While looking for posts in the series, this plugin makes two database queries for each post in the series : one to find out if the post is published, and another to get the part number in the series. So if you have 30 posts in the series, you will get 60 queries from this plugin alone on each post belonging to that series. I found this very wasteful, and rewrote one function so that it only uses one database query, no matter what the number of posts in the series. I think <a href="http://unfoldingneurons.com">the author</a> should be interested...</p>

<p>Basically, in the file series-utility.php, replace the function
function get_series_order($posts, $postid = 0, $skip = TRUE)
by the following one :
<code lang="php">
&lt;?php
function get_series_order($posts, $postid = 0, $skip = TRUE) {
  global $wpdb;
  if (!isset($posts)) return false; //don't have the posts array so can't do anything.</p>

<p>  if ( !is_array( $posts )
  $posts = array($posts);</p>

<p>  $series_posts = array();
  $key = 0;</p>

<p>  foreach ($posts as $spost) {</p>

<pre><code>if (array_key_exists('object_id', $posts)) {
  if ($key!=0){
    $spost_id .= ",".$spost['object_id'];
  }else{
    $spost_id .= $spost['object_id'];
  }
} else {
  if ($key!=0){
    $spost_id .= ",".$spost;
  }else{
    $spost_id .= $spost;
  }
}
$key++;
</code></pre>

<p>  }</p>

<p>  //Optimized : 1 SQL query instead of 2<em> number ofposts in series//
  $results=$wpdb->get_results("SELECT $wpdb->posts.ID, $wpdb->postmeta.meta_value
  FROM $wpdb->posts LEFT JOIN $wpdb->postmeta
  ON($wpdb->posts.ID = $wpdb->postmeta.post_id)
  WHERE post_status = 'publish' AND $wpdb->posts.ID
  IN (".$spost_id.") AND ener_postmeta.meta_key='".SERIES_PART_KEY."'");
  /</em> 208 - fix by Matt Porter - to make sure unpublished posts are not made part of a series */
  foreach ($results as $num=>$result) {</p>

<pre><code>//echo "&lt;h1&gt;resultat".$result-&gt;ID.$result&gt;meta_value."&lt;/h1&gt;";
$series_posts[$num]['id'] =$result-&gt;ID;
$series_posts[$num]['part'] = $result-&gt;meta_value;
</code></pre>

<p>  }</p>

<p>  if (count($series_posts) > 1)</p>

<pre><code>usort( $series_posts, '_usort_series_by_part' );
</code></pre>

<p>  return $series_posts;
}
?>
</code>
And there you go, a faster blog...While looking for posts in the series, this plugin makes two database queries for each post in the series : one to find out if the post is published, and another to get the part number in the series. So if you have 30 posts in the series, you will get 60 queries from this plugin alone on each post belonging to that series. I found this very wasteful, and rewrote one function so that it only uses one database query, no matter what the number of posts in the series. I think <a href="http://unfoldingneurons.com">the author</a> should be interested...</p>

<p>Basically, in the file series-utility.php, replace the function
function get_series_order($posts, $postid = 0, $skip = TRUE)
by the following one :</p>

<p>&lt;?php
function get_series_order($posts, $postid = 0, $skip = TRUE) {
global $wpdb;
if (!isset($posts)) return false; //don't have the posts array so can't do anything.</p>

<p>if ( !is_array( $posts )
$posts = array($posts);</p>

<p>$series_posts = array();
$key = 0;</p>

<p>foreach ($posts as $spost) {
if (array_key_exists('object_id', $posts)) {
if ($key!=0){
$spost_id .= ",".$spost['object_id'];
}else{
$spost_id .= $spost['object_id'];
}
} else {
if ($key!=0){
$spost_id .= ",".$spost;
}else{
$spost_id .= $spost;
}
}
$key++;
}</p>

<p>//Optimized : 1 SQL query instead of 2<em> number ofposts in series//
$results=$wpdb-&gt;get_results("SELECT $wpdb-&gt;posts.ID, $wpdb-&gt;postmeta.meta_value
FROM $wpdb-&gt;posts LEFT JOIN $wpdb-&gt;postmeta
ON($wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id)
WHERE post_status = 'publish' AND $wpdb-&gt;posts.ID
IN (".$spost_id.") AND ener_postmeta.meta_key='".SERIES_PART_KEY."'");
/</em> 208 - fix by Matt Porter - to make sure unpublished posts are not made part of a series */
foreach ($results as $num=&gt;$result) {
//echo "&lt;h1&gt;resultat".$result-&gt;ID.$result-&gt;meta_value."&lt;/h1&gt;";
$series_posts[$num]['id'] =$result-&gt;ID;
$series_posts[$num]['part'] = $result-&gt;meta_value;
}</p>

<p>if (count($series_posts) &gt; 1)
usort( $series_posts, '_usort_series_by_part' );</p>

<p>return $series_posts;
}
?&gt;</p>

<p>And there you go, a faster blog...</p>

                <div class="meta">
                    <!-- <span class="pdf">Download a <a href="/2009/05/19/organize-series-plugin-database-optimization.html.pdf" title="Download a PDF, printer-friendly copy of this article"><acronym title="Portable Document Format">PDF</acronym>, printer-friendly version of this article</a>.</span> -->
                    <span class="permalink">For referencing: <a href="/2009/05/19/organize-series-plugin-database-optimization.html" title="[Permalink] Organize Series plugin database optimization">permalink to this article</a>.</span>
                </div> <!-- /.meta -->
            </div> <!-- /.entry-content.colEight -->
            <div class="page-nav-bottom">
                
				    <span class="page-nav-item floatLeft"><a class="internal" rel="prev"  href="/2009/05/19/amazon-wishlist-plugin-for-wordpress-27.html/#notebook" title="View Amazon Wishlist plugin for wordpress 2.7">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item floatRight"><a class="internal" rel="next"  href="/2009/06/04/auto-tag-wordpress-plugin.html/#notebook" title="View Auto Tag Wordpress plugin">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-bottom -->
        </div> <!-- /#notebook.center.clear -->
                <div id="footer" class="center clear">
			<ul class="nav nav-footer caps">
				<li><a href="/about.html" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
				<li><a href="/archives.html#cover" title="View the notebook entries" tabindex="0">Notebook</a></li>
				<li><a href="/#portfolio" title="Skip back up to the portfolio" tabindex="0">Portfolio</a></li>
				<li><a href="http://feeds.feedburner.com/klepas" title="Feed link" tabindex="0">Feed</a></li>
			</ul>
			<span class="backtop floatRight"><a class="internal" href="#header" title="Return to the top of this page">Back to top &uarr;</a></span>
			<div class="page-meta clear">
				<div class="info">
					<span class="index">&#9758;</span><p class="vcard"><a href="/files/Simon-Pascal-Klein.vcf" title="Download Simon Pascal Klein&rsquo;s addressbook vCard">Add me to your address book via vCard</a>.</p>
					<p class="copyright clear">Proudly bending beziers since <abbr class="date" title="2004">MMIV</abbr>&ndash;; copyright &copy; Simon Pascal Klein thereon.</p>
					<p class="licensing"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/au/" title="Content, unless specificed, licensed under a Creative Commons license">Some rights reserved</a>.</p>
					<p>For an overview of the site, see the <a href="/sitemap/" title="View the site map">site map</a> or <a href="/archives.html#cover" title="View the notebook archives">notebook archives</a>.</p>
					<h2>A playful tumble with <em>type</em>&hellip; &rarr;</h2>
					<p>&hellip;yes, <em>type</em>, not a graphic; try selecting it or resizing the page font size. Inspired by <a href="http://jontangerine.com/" title="jontangerine.com: Jon Tan&rsquo;s website">Jon Tan</a>&rsquo;s masterhead type folly, this is achieved just with some simple nested <code><span class="element">span</span></code> elements that are positioned absolutely against their relative parents, and the entire thing is sized in ems and scales nicely.</p>
				</div>
				<div class="type-folly">
					<em>Type
						<span>set
							<span>with
								<span>love
									<span>{
										<span>&hearts;
											<span>}</span>
										</span>
									</span>
								</span>
							</span>
						</span>
					</em>
					<strong>in
						<span>Georgia
							<span>&amp;
								<span>Museo</span>
							</span>
						</span>
					</strong>
					<span class="markup">&hellip;all in mostly valid <a rel="external" href="http://jigsaw.w3.org/css-validator/check/referer"><acronym title="Cascading Style Sheets">CSS</acronym></a> <span class="amp">&amp;</span> <a rel="external" href="http://validator.w3.org/check?uri=referer"><acronym title="eXtensible Hyper Text Markup Language">XHTML</acronym></a>; as <acronym title="plain old semantic (X)HTML">POSH</acronym> as can be.</span>
				</div>
			</div> <!-- /.page-meta.clear -->
		</div> <!-- /#footer.center.clear -->
	</div>
</body>
</html>
