<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="description" content="A blog about web development, codeigniter and wordpress, by web developer Jonathan Foucher" />
<title>Organize Series plugin database optimization</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css"  href="/assets/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/assets/css/pygments.css" />
<link rel="icon" href="/favicon.png" type="image/png" />
    
<meta name="viewport"
  content="width=device-width,
  minimum-scale=1.0, maximum-scale=1.0" />
</head>

<body>
<div id="wrapper" class="hfeed">
	<div id="header">
		<div id="masthead">

			<div id="access" role="navigation">
				<div class="skip-link screen-reader-text"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu-header">
    <ul id="menu-new" class="menu">
        <li class="menu-item">
            <a href="http://jfoucher.com">Blog</a>
        </li>
        <li class="menu-item">
            <a title="view my page on about.me" href="http://about.me/jfoucher">About
me</a>
        </li>
        <li class="menu-item">
            <a title="latest works" href="http://jfoucher.fr/">Portfolio</a>
        </li>
        <li class="menu-item"><a title="feedly inspired theme" href="http://jfoucher.com/wp-feedly">WP Feedly</a>
        </li>
    </ul>
</div>

			</div><!-- #access -->
			<div id="branding" role="banner">
				
                <div id="site-title">
                  
					<span>
						<a href="/" title="Geeky Nuggets" rel="home">Geeky Nuggets</a>
					</span>
				
                </div>
                  

				<div id="site-description">Jonathan Foucher's blog <span class="amp">&amp;</span> web development notebook</div>
			</div><!-- #branding -->

		</div><!-- #masthead -->
	</div><!-- #header -->

	<div id="main">


<div id="content">


    <div id="nav-above" class="navigation">
    

    <div class="nav-previous">
        <a href="/2009/05/19/amazon-wishlist-plugin-for-wordpress-27.html" rel="prev" title="View Amazon Wishlist plugin for wordpress 2.7">
            <span class="meta-nav">←</span> Amazon Wishlist plugin for wordpress 2.7</a></div>

          
    

    <div class="nav-next">
        <a href="/2009/06/04/auto-tag-wordpress-plugin.html" rel="prev" title="View Auto Tag Wordpress plugin">Auto Tag Wordpress plugin <span class="meta-nav">→</span></a></div>

          
</div>
    <div id="/2009/05/19/organize-series-plugin-database-optimization.html" class="post">
        
<p class="the-date">19 May 2009</p>
<h2 class="entry-title"><a href="/2009/05/19/organize-series-plugin-database-optimization.html" title="Permanent link to " rel="bookmark">Organize Series plugin database optimization</a></h2>


<p>While looking for posts in the series, this plugin makes two database queries for each post in the series : one to find out if the post is published, and another to get the part number in the series. So if you have 30 posts in the series, you will get 60 queries from this plugin alone on each post belonging to that series. I found this very wasteful, and rewrote one function so that it only uses one database query, no matter what the number of posts in the series. I think <a href="http://unfoldingneurons.com">the author</a> should be interested...</p>

<p>Basically, in the file series-utility.php, replace the function
function get_series_order($posts, $postid = 0, $skip = TRUE)
by the following one :
<code lang="php">
&lt;?php
function get_series_order($posts, $postid = 0, $skip = TRUE) {
  global $wpdb;
  if (!isset($posts)) return false; //don't have the posts array so can't do anything.</p>

<p>  if ( !is_array( $posts )
  $posts = array($posts);</p>

<p>  $series_posts = array();
  $key = 0;</p>

<p>  foreach ($posts as $spost) {</p>

<pre><code>if (array_key_exists('object_id', $posts)) {
  if ($key!=0){
    $spost_id .= ",".$spost['object_id'];
  }else{
    $spost_id .= $spost['object_id'];
  }
} else {
  if ($key!=0){
    $spost_id .= ",".$spost;
  }else{
    $spost_id .= $spost;
  }
}
$key++;
</code></pre>

<p>  }</p>

<p>  //Optimized : 1 SQL query instead of 2<em> number ofposts in series//
  $results=$wpdb->get_results("SELECT $wpdb->posts.ID, $wpdb->postmeta.meta_value
  FROM $wpdb->posts LEFT JOIN $wpdb->postmeta
  ON($wpdb->posts.ID = $wpdb->postmeta.post_id)
  WHERE post_status = 'publish' AND $wpdb->posts.ID
  IN (".$spost_id.") AND ener_postmeta.meta_key='".SERIES_PART_KEY."'");
  /</em> 208 - fix by Matt Porter - to make sure unpublished posts are not made part of a series */
  foreach ($results as $num=>$result) {</p>

<pre><code>//echo "&lt;h1&gt;resultat".$result-&gt;ID.$result&gt;meta_value."&lt;/h1&gt;";
$series_posts[$num]['id'] =$result-&gt;ID;
$series_posts[$num]['part'] = $result-&gt;meta_value;
</code></pre>

<p>  }</p>

<p>  if (count($series_posts) > 1)</p>

<pre><code>usort( $series_posts, '_usort_series_by_part' );
</code></pre>

<p>  return $series_posts;
}
?>
</code>
And there you go, a faster blog...While looking for posts in the series, this plugin makes two database queries for each post in the series : one to find out if the post is published, and another to get the part number in the series. So if you have 30 posts in the series, you will get 60 queries from this plugin alone on each post belonging to that series. I found this very wasteful, and rewrote one function so that it only uses one database query, no matter what the number of posts in the series. I think <a href="http://unfoldingneurons.com">the author</a> should be interested...</p>

<p>Basically, in the file series-utility.php, replace the function
function get_series_order($posts, $postid = 0, $skip = TRUE)
by the following one :</p>

<p>&lt;?php
function get_series_order($posts, $postid = 0, $skip = TRUE) {
global $wpdb;
if (!isset($posts)) return false; //don't have the posts array so can't do anything.</p>

<p>if ( !is_array( $posts )
$posts = array($posts);</p>

<p>$series_posts = array();
$key = 0;</p>

<p>foreach ($posts as $spost) {
if (array_key_exists('object_id', $posts)) {
if ($key!=0){
$spost_id .= ",".$spost['object_id'];
}else{
$spost_id .= $spost['object_id'];
}
} else {
if ($key!=0){
$spost_id .= ",".$spost;
}else{
$spost_id .= $spost;
}
}
$key++;
}</p>

<p>//Optimized : 1 SQL query instead of 2<em> number ofposts in series//
$results=$wpdb-&gt;get_results("SELECT $wpdb-&gt;posts.ID, $wpdb-&gt;postmeta.meta_value
FROM $wpdb-&gt;posts LEFT JOIN $wpdb-&gt;postmeta
ON($wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id)
WHERE post_status = 'publish' AND $wpdb-&gt;posts.ID
IN (".$spost_id.") AND ener_postmeta.meta_key='".SERIES_PART_KEY."'");
/</em> 208 - fix by Matt Porter - to make sure unpublished posts are not made part of a series */
foreach ($results as $num=&gt;$result) {
//echo "&lt;h1&gt;resultat".$result-&gt;ID.$result-&gt;meta_value."&lt;/h1&gt;";
$series_posts[$num]['id'] =$result-&gt;ID;
$series_posts[$num]['part'] = $result-&gt;meta_value;
}</p>

<p>if (count($series_posts) &gt; 1)
usort( $series_posts, '_usort_series_by_part' );</p>

<p>return $series_posts;
}
?&gt;</p>

<p>And there you go, a faster blog...</p>

</div>

    </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'geekynuggets'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
<div id="primary" class="widget-area" role="complementary">
<ul class="xoxo">
    <li id="archives-3" class="widget-container widget_archive">
        <h3 class="widget-title">Archives</h3>
        <ul>
            <li><a href='http://jfoucher.com/2011/08' title='August 2011'>August 2011</a></li>
            <li><a href='http://jfoucher.com/2011/06' title='June 2011'>June 2011</a></li>
            <li><a href='http://jfoucher.com/2011/04' title='April 2011'>April 2011</a></li>
            <li><a href='http://jfoucher.com/2011/02' title='February 2011'>February 2011</a></li>
            <li><a href='http://jfoucher.com/2011/01' title='January 2011'>January 2011</a></li>
            <li><a href='http://jfoucher.com/2010/05' title='May 2010'>May 2010</a></li>
            <li><a href='http://jfoucher.com/2010/01' title='January 2010'>January 2010</a></li>
            <li><a href='http://jfoucher.com/2009/12' title='December 2009'>December 2009</a></li>
            <li><a href='http://jfoucher.com/2009/11' title='November 2009'>November 2009</a></li>
            <li><a href='http://jfoucher.com/2009/10' title='October 2009'>October 2009</a></li>
            <li><a href='http://jfoucher.com/2009/07' title='July 2009'>July 2009</a></li>
            <li><a href='http://jfoucher.com/2009/06' title='June 2009'>June 2009</a></li>
            <li><a href='http://jfoucher.com/2009/05' title='May 2009'>May 2009</a></li>
            <li><a href='http://jfoucher.com/2009/04' title='April 2009'>April 2009</a></li>
            <li><a href='http://jfoucher.com/2006/03' title='March 2006'>March 2006</a></li>
            <li><a href='http://jfoucher.com/2005/04' title='April 2005'>April 2005</a></li>
            <li><a href='http://jfoucher.com/2005/03' title='March 2005'>March 2005</a></li>
            <li><a href='http://jfoucher.com/2004/11' title='November 2004'>November 2004</a></li>
            <li><a href='http://jfoucher.com/2004/10' title='October 2004'>October 2004</a></li>
            <li><a href='http://jfoucher.com/2004/09' title='September 2004'>September 2004</a></li>
            <li><a href='http://jfoucher.com/2004/08' title='August 2004'>August 2004</a></li>
            <li><a href='http://jfoucher.com/2004/04' title='April 2004'>April 2004</a></li>
            <li><a href='http://jfoucher.com/2004/03' title='March 2004'>March 2004</a></li>
        </ul>
    </li>
    <li id="text-6" class="widget-container widget_text">
        <div class="textwidget">
            <a href="http://stackoverflow.com/users/210824/jfoucher">
<img src="http://stackexchange.com/users/flair/f354d74ced334d5984ea2db33cf8024a.png" width="208" height="58" alt="profile for jfoucher on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for jfoucher on Stack Exchange, a network of free, community-driven Q&amp;A sites"> 
</a> 
<div style="margin-right:15px;float:left;"><a href="http://twitter.com/share" class="twitter-share-button" data-count="vertical">Tweet</a></div><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script> 
<g:plusone size="tall" count="true"></g:plusone> 
<iframe src="http://www.facebook.com/plugins/like.php?app_id=228358510507833&amp;href&amp;send=false&amp;layout=box_count&amp;width=50&amp;show_faces=true&amp;action=like&amp;colorscheme=light&amp;font=segoe+ui&amp;height=60" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:50px; height:60px;margin-left:25px" allowTransparency="true"></iframe></div> 
		</li><li id="recent-comments-3" class="widget-container widget_recent_comments"><h3 class="widget-title">Recent Comments</h3><ul id="recentcomments"><li class="recentcomments"><a class="comment-post-title-link" href="http://jfoucher.com/2011/04/css-minification-library-for-codeigniter.html#comment-14518"><!--:en-->CSS minification library for codeigniter<!--:--></a> (2)</li><li class="recentcomments"><a class="comment-post-title-link" href="http://jfoucher.com/2011/01/python-skype-notifier-for-ubuntu.html#comment-12631"><!--:en-->Python skype notifier for Ubuntu<!--:--></a> (15)</li><li class="recentcomments"><a class="comment-post-title-link" href="http://jfoucher.com/2009/06/wpfeedly-theme-download.html#comment-12060"><!--:en-->WP-Feedly theme available for download<!--:--></a> (6)</li><li class="recentcomments"><a class="comment-post-title-link" href="http://jfoucher.com/2011/01/wordpress-email-404-notification.html#comment-10882">WordPress 404 notification by email</a> (2)</li><li class="recentcomments"><a class="comment-post-title-link" href="http://jfoucher.com/2009/06/auto-tag-wordpress-plugin.html#comment-9966"><!--:en-->Auto Tag WordPress plugin<!--:--></a> (44)</li></ul></li><li id="text-8" class="widget-container widget_text"><h3 class="widget-title">Subscribe</h3>			<div class="textwidget"><ul> 
<li> 
<a href="http://feeds.feedburner.com/GeekyNuggets" rel="alternate" type="application/rss+xml">Subscribe in a reader</a>&nbsp;<a href="http://feeds.feedburner.com/GeekyNuggets" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a></li> 
<li> 
<a href="http://feedburner.google.com/fb/a/mailverify?uri=GeekyNuggets&amp;loc=en_US">Subscribe by Email</a>&nbsp;<a href="http://feedburner.google.com/fb/a/mailverify?uri=GeekyNuggets&amp;loc=en_US"><img src="/wp-content/themes/jfoucher/images/icon_email_small.gif" style="vertical-align:middle;border:0" alt="" /></a></li></ul></div> 

</li>
</ul>

</div><!-- #primary .widget-area -->
</div>
<!--End #main -->
<div id="footer">
</div>
<script type="text/javascript" src="http://use.typekit.com/mmi3jba.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>


</body>
</html>

