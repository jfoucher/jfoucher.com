<!DOCTYPE html> 
<html lang="en">
<!--
	Access keys:
		H = homepage
		S = search input field
		L = latest article on the homepage
		A = about page
-->
<head>
    <title>
        Python skype notifier for Ubuntu
        
    </title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="author" content="Jonathan Foucher" />
	<meta name="designer" content="Jonathan Foucher" />
	<meta name="developer" content="Jonathan Foucher" />
	<meta name="description" content="Learning python by building a semi-useful Skype instant message notifier" />
	<meta name="keywords" content="Web development, france, wordpress, codeigniter, linux, ubuntu, debian, system administration" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
	<link rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/en/" />
    <link href="http://tent.jfoucher.com/profile" rel="https://tent.io/rels/profile" />
    <link href='http://fonts.googleapis.com/css?family=Questrial' rel='stylesheet' type='text/css'>
	<!--<link rel="stylesheet" href="/assets/css/screen.css" type="text/css" media="screen" />-->

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>

	<script type="text/javascript" src="/assets/js/app.js"></script>
    <link rel="stylesheet" href="/assets/css/screen.css" type="text/css" media="screen" />
    <!--[if lt IE 9]>
    <script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <script type="text/javascript" src="http://www.shrinktheweb.com/scripts/pagepix.js"></script>
	<link rel="alternate" href="http://feeds.feedburner.com/GeekyNuggets" title="Geeky Nuggets" type="application/atom+xml" />

	<link rel="shortcut icon" type="image/png" href="/favicon.png" />

</head>
<body>


	<div id="container" class="clearfix">
		                <header id="header" class="center">
            <div class="logo">
                <a href="/" title="Return to homepage" tabindex="0" accesskey="H">
                    Geeky Nuggets
                </a>
            </div>
            <div class="siteDesc"><a href="/about.html" title="About Jonathan Foucher
                &amp; contact details" tabindex="0" accesskey="A">Jonathan Foucher</a>&rsquo;s blog <span
                class="amp">&amp;</span> web development
                notebook.
            </div>
                    <nav id="nav" class="clear">
            <ul class="nav nav-header caps">
				<li><a href="/about.html" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
				<li class="active"><a href="/archives.html" title="View the blog archives" tabindex="0">Archives</a></li>

				<li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Subscribe to my posts, by email or in your feed reader" tabindex="0">Feed</a></li>
            </ul>
			<div class="sitesearch">

                <!-- Google Custom Search Element -->
                <!-- <form action="http://www.google.com/cse" class="center_column" id="searchForm" >
                    <fieldset>
                       <input type="hidden" name="cx" value="004905032692135561336:flcwnz7i1ww" />
                       <input type="hidden" name="ie" value="UTF-8" />
                       <label for="search" class="hidden">Search</label>
                       <input id="search" class="text-input" type="text" name="q" size="15" tabindex="0" accesskey="S" />
                       <input id="searchsubmit" type="submit" name="sa" value="Search" tabindex="0" />
                    </fieldset>
                </form>-->

            </div>

        </nav> <!-- /#nav.clear -->


            
		</header> <!-- /#header.center -->


		<div id="notebook" class="center clear">
			<div class="page-nav-top">
                
				    <span class="page-nav-item page-prev"><a class="internal" rel="prev"  href="/2011/01/compile-custom-kernel-on-ubuntu-10-10.html" title="View Compile custom kernel on Ubuntu 10.10">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item page-next"><a class="internal" rel="next"  href="/2011/01/spanish-characters-on-qwerty-keyboard-for-ubuntu-10-10.html" title="View Spanish characters on Qwerty keyboard for Ubuntu 10.10">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-top -->

             <h2 class="post-title">
                <a href="/2011/01/python-skype-notifier-for-ubuntu.html" title="Permanent link to Python skype notifier for Ubuntu">
                    Python skype notifier for Ubuntu
                </a>
            </h2>

            <div class="meta">
                <div class="hero">

                    <p>
                        Learning python by building a semi-useful Skype instant message notifier
                    </p>
                </div>
                <!-- <span class="pdf">Download a <a href="/2011/01/python-skype-notifier-for-ubuntu.html.pdf" title="Download a PDF, printer-friendly copy of this article"><acronym title="Portable Document Format">PDF</acronym>, printer-friendly version of this article</a>.</span> -->
                <span class="permalink">For referencing: <a href="/2011/01/python-skype-notifier-for-ubuntu.html" title="[Permalink] Python skype notifier for Ubuntu">permalink to this article</a>.</span>
                    <span class="date" title="Fri Jan 14 13:21:52 +0100 2011">
                    <span class="published">Published&thinsp;&bull;</span>
                    <span class="day">14</span>
                    <span class="month"><abbr>Jan</abbr></span>
                    <span class="year">2011</span>
                </span>
                <div class="share">
                    <div class="iframes">
                        <a href="https://twitter.com/share" class="twitter-share-button" data-via="jfoucher">Tweet</a>
                        

                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    </div>
                </div>
            </div> <!-- /.meta -->
            <div id="entry-content">

                <p>What&#8217;s the best way to learn a new programming language ? Well, according to <a href='http://programmers.stackexchange.com/q/3519/3984'>this question</a> the best (only ?) way to learn a new language is just to code in that language. <h3>Why Python ?</h3> Because it&#8217;s <a href='http://en.wikipedia.org/wiki/Python_(programming_language)#Name_and_neologisms'>named after the Monty Python</a></p>

<p>No, seriously, that&#8217;s why :<a href='http://xkcd.com/353/'><img src='http://jfoucher.com/uploads/2011/01/python-264x300.png' title='python' width='264' alt='I wrote 20 short programs in Python yesterday.  It was wonderful.  Perl, I&apos;m leaving you.' class='aligncenter size-medium wp-image-201' height='300' /></a>No, not this &#8220;that&#8217;s why&#8221;! <a href='http://programmers.stackexchange.com/questions/10675/ideal-programming-language-learning-sequence#answer-10748'>That one</a></p>

<p>If you are just starting out as a programmer, I cannot recommend <a href='http://learnpythonthehardway.org/'>Learn Python The Hard Way</a> highly enough. It is an excellent introduction to the ideas and skills you will need as a programmer, starting from the very basics, like you&#8217;ve never seen a for loop in your life. Actually the first 10 or so lessons do not include ANY control structures!</p>

<p>If on the other hand you already have some coding experience, I recomend <a href='http://diveintopython.org/'>Dive Into Python</a>. Although it&#8217;s no quite as hands on as Learn Python the Hard Way, it&#8217;s a very good book, only covering the basics insofar as they are specific to python. <h3>Why for <a href='/2011/01/193-compile-custom-kernel-on-ubuntu-10-10.html'>Ubuntu</a>?</h3> That&#8217;s what I use. Simple as that. Also python and pygtk are included by default, making distribution much easier. <h3>Why Skype?</h3> Haven&#8217;t found out yet. I started developping a backup application in pygtk and glade, a front end to rsync, but got sidetracked reading about the chnges to Ubuntu&#8217;s <a href='https://wiki.ubuntu.com/DesktopExperienceTeam/ApplicationIndicators'>application notifier</a>, ended up interested in the <a href='https://wiki.ubuntu.com/MessagingMenu'>messaging notifier</a>, and decided to do something with that.</p>

<p>Skype seemed like the obvious target, given that&#8217;s it&#8217;s the only communication application I use that lacks a messaging menu indicator. It does have a systray icon though, so my app is probably superfluous&#8230; <h3>Anyway, to the coding!</h3></p>
<div class='highlight'><pre><code class='python'><span class='c'>#!/usr/bin/env python</span>

<span class='kn'>import</span> <span class='nn'>indicate</span>
<span class='kn'>import</span> <span class='nn'>gobject</span>
<span class='kn'>import</span> <span class='nn'>pynotify</span>
<span class='kn'>import</span> <span class='nn'>gtk</span>
<span class='kn'>import</span> <span class='nn'>hashlib</span>
<span class='kn'>import</span> <span class='nn'>Skype4Py</span>
<span class='kn'>import</span> <span class='nn'>urllib</span>
<span class='kn'>import</span> <span class='nn'>os</span>
</code></pre></div>
<p>The first line tell the host system to use python to interpret that file</p>

<p>The next lines import the required python modules.</p>

<p>Next, we have to define the main class and declare some variables:</p>
<div class='highlight'><pre><code class='python'><span class='k'>class</span> <span class='nc'>skypeIndicator</span><span class='p'>:</span>
    <span class='n'>notifShown</span><span class='o'>=</span><span class='p'>{}</span>
    <span class='n'>oldcount</span><span class='o'>=</span><span class='p'>{}</span>
    <span class='n'>count</span><span class='o'>=</span><span class='p'>{}</span>
    <span class='n'>indicator</span><span class='o'>=</span><span class='p'>{}</span>
</code></pre></div>
<p>This is the clas initialization function</p>
<div class='highlight'><pre><code class='python'>    <span class='k'>def</span> <span class='nf'>__init__</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>=</span> <span class='n'>Skype4Py</span><span class='o'>.</span><span class='n'>Skype</span><span class='p'>()</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>loadSkype</span><span class='p'>()</span>
        <span class='c'>#create notification icon</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span> <span class='o'>=</span> <span class='n'>indicate</span><span class='o'>.</span><span class='n'>indicate_server_ref_default</span><span class='p'>()</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>set_type</span><span class='p'>(</span><span class='s'>&quot;message.im&quot;</span><span class='p'>)</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>set_desktop_file</span><span class='p'>(</span><span class='s'>&quot;/usr/share/applications/skype.desktop&quot;</span><span class='p'>)</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>connect</span><span class='p'>(</span><span class='s'>&quot;server-display&quot;</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>server_display</span><span class='p'>)</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>create_indicators</span><span class='p'>()</span>
</code></pre></div>
<p>The first line creates the skype API instance, after which we call the loadSkype() function, which checks if skype is loaded and if not, starts it. We&#8217;ll look at that function later on. Next, we create the notification server instance, choose an icon, connect the function server_display to the server-display event (when the icon is clicked on) and finally run the create_indicators function that looks for skype messages and displays them accordingly.</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>loadSkype</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='k'>try</span><span class='p'>:</span>
			<span class='k'>if</span> <span class='ow'>not</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>IsRunning</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>Start</span><span class='p'>()</span>
		<span class='k'>except</span><span class='p'>:</span>
			<span class='c'>#</span>
			<span class='k'>print</span> <span class='s'>&quot;Please open skype first&quot;</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>noSkype</span><span class='p'>()</span>
		<span class='k'>try</span><span class='p'>:</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Attach</span><span class='p'>()</span>
		<span class='k'>except</span> <span class='n'>Skype4Py</span><span class='o'>.</span><span class='n'>errors</span><span class='o'>.</span><span class='n'>ISkypeAPIError</span><span class='p'>:</span>
			<span class='k'>print</span> <span class='s'>&quot;Please open skype first&quot;</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>noSkype</span><span class='p'>()</span>
</code></pre></div>
<p>This basically tries to start skype if it is not already started and calls noSkype() if it couldn&#8217;t start it. noSype() shows a notification message to let the user know that they have to start Skype. <a href='http://jfoucher.com/uploads/2011/01/skype-not-started.png'><img src='http://jfoucher.com/uploads/2011/01/skype-not-started.png' title='skype-not-started' width='428' alt='Error shown if Skype is not running' class='aligncenter size-full wp-image-256' height='213' /></a></p>

<p>This next function is where the meat of the process takes place. Please read the inline comments to understand how it works, and ask for clarification by <a href='#respond'>posting a comment</a>.</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>create_indicators</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>

		<span class='sd'>&quot;&quot;&quot;Loads skype messages, displays them as notification bubbles and also shows them in the messaging menu&quot;&quot;&quot;</span>

		<span class='c'>#initialize count dictionaries</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='o'>=</span><span class='p'>{}</span>
		<span class='c'>#get unread messages from skype, set self.unread variable</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>get_messages</span><span class='p'>()</span>

		<span class='c'>#self.unread is a dictionary having the username of the sender as key and a list of messages as value</span>
		<span class='k'>for</span> <span class='n'>name</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>:</span>

			<span class='c'># Here we look at the first message from this user to set the messaging menu indicator</span>
			<span class='c'># we only want one indicator per user</span>
			<span class='n'>msg</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>name</span><span class='p'>][</span><span class='mi'>0</span><span class='p'>]</span>

			<span class='c'>#initialize message count for this user</span>
			<span class='k'>if</span> <span class='n'>name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='mi'>0</span>
			<span class='k'>if</span> <span class='n'>name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='mi'>0</span>

			<span class='c'># if this user doesn&#39;t have his indicator yet</span>
			<span class='k'>if</span> <span class='n'>name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>:</span>
				<span class='c'># create indicator</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span> <span class='o'>=</span> <span class='n'>indicate</span><span class='o'>.</span><span class='n'>Indicator</span><span class='p'>()</span>
				<span class='k'>print</span> <span class='s'>&quot;creating indicator&quot;</span>

				<span class='c'># Set indicator properties</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>fullname</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>name_from_handle</span><span class='p'>(</span><span class='n'>name</span><span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;subtype&quot;</span><span class='p'>,</span> <span class='s'>&quot;im&quot;</span><span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;sender&quot;</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>fullname</span> <span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;handle&quot;</span><span class='p'>,</span> <span class='n'>name</span><span class='p'>)</span>

				<span class='c'>#this gets the most user-friendly name available for this user</span>
				<span class='n'>user</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>user_from_handle</span><span class='p'>(</span><span class='n'>name</span><span class='p'>)</span>

				<span class='c'># get an avatar for this user</span>
				<span class='k'>try</span><span class='p'>:</span>
					<span class='c'># This will only work on windows</span>
					<span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='o'>=</span><span class='n'>name</span> <span class='o'>+</span> <span class='s'>&#39;.jpg&#39;</span>
					<span class='n'>user</span><span class='o'>.</span><span class='n'>SaveAvatarToFile</span><span class='p'>(</span><span class='nb'>file</span><span class='p'>)</span>
				<span class='k'>except</span> <span class='n'>Skype4Py</span><span class='o'>.</span><span class='n'>errors</span><span class='o'>.</span><span class='n'>ISkypeError</span><span class='p'>:</span>
					<span class='c'># So on linux we use a generated monster ID. Fun but useless!</span>
					<span class='n'>h</span><span class='o'>=</span><span class='n'>hashlib</span><span class='o'>.</span><span class='n'>md5</span><span class='p'>(</span><span class='n'>name</span><span class='p'>)</span><span class='o'>.</span><span class='n'>hexdigest</span><span class='p'>()</span>
					<span class='c'>#TODO find a way to get skype avatars on linux</span>
					<span class='n'>urllib</span><span class='o'>.</span><span class='n'>urlretrieve</span><span class='p'>(</span><span class='s'>&#39;http://friedcellcollective.net/monsterid/monster/</span><span class='si'>%s</span><span class='s'>/64&#39;</span> <span class='o'>%</span> <span class='n'>h</span><span class='p'>,</span><span class='n'>name</span> <span class='o'>+</span> <span class='s'>&#39;.jpg&#39;</span><span class='p'>)</span>
					<span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='o'>=</span><span class='n'>name</span> <span class='o'>+</span> <span class='s'>&#39;.jpg&#39;</span>

				<span class='c'>#convert the imge to a pixbuf</span>
				<span class='n'>pixbuf</span><span class='o'>=</span><span class='n'>gtk</span><span class='o'>.</span><span class='n'>gdk</span><span class='o'>.</span><span class='n'>pixbuf_new_from_file</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='p'>)</span>
				<span class='c'># for use in the indicator</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property_icon</span><span class='p'>(</span><span class='s'>&quot;icon&quot;</span><span class='p'>,</span> <span class='n'>pixbuf</span><span class='p'>)</span>

				<span class='c'># set the timestamp of the indicator (this is what makes the indicator display the time since the message was received</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property_time</span><span class='p'>(</span><span class='s'>&quot;time&quot;</span><span class='p'>,</span> <span class='n'>msg</span><span class='o'>.</span><span class='n'>Timestamp</span><span class='p'>)</span>

				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>
				<span class='c'># when the user clicks on the indicator message, open the skype messaging window for this user</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>connect</span><span class='p'>(</span><span class='s'>&quot;user-display&quot;</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>display_msg</span><span class='p'>)</span>
				
			<span class='n'>msgbody</span> <span class='o'>=</span> <span class='s'>&#39;&#39;</span>
			<span class='c'>#reverse list so latest message is at the bottom</span>
			<span class='k'>for</span> <span class='n'>eachmsg</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>name</span><span class='p'>][::</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>]:</span>
				<span class='c'># msgbody contains all the messages from that user so far</span>
				<span class='n'>msgbody</span> <span class='o'>+=</span> <span class='n'>eachmsg</span><span class='o'>.</span><span class='n'>Body</span> <span class='o'>+</span> <span class='s'>&quot;</span><span class='se'>\n</span><span class='s'>&quot;</span>

			<span class='c'># We set this person&#39;s indicator body to the compound text</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;body&quot;</span><span class='p'>,</span> <span class='n'>msgbody</span><span class='p'>)</span>

			<span class='c'># if there are more than one message from this user, we set the indicator count to be displayed in the messaging menu.</span>
			<span class='c'># Otherwise the time elapsed since receiving the message will be shown</span>
			<span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span> <span class='o'>&gt;</span> <span class='mi'>1</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;count&quot;</span><span class='p'>,</span> <span class='nb'>str</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]))</span>
			
			<span class='c'># If a new message arrived since last time checked, mark notification as not shown</span>
			<span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span> <span class='o'>&gt;</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>notifShown</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='bp'>False</span>

			<span class='c'>#If notification marked as not shown, show it</span>
			<span class='k'>if</span> <span class='ow'>not</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>notifShown</span><span class='o'>.</span><span class='n'>get</span><span class='p'>(</span><span class='n'>name</span><span class='p'>,</span> <span class='bp'>False</span><span class='p'>)</span> <span class='ow'>and</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>showNotification</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>fullname</span><span class='p'>,</span> <span class='n'>msgbody</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='p'>):</span>
				<span class='c'>#mark notification as shown</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>notifShown</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='bp'>True</span>

				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;draw-attention&quot;</span><span class='p'>,</span> <span class='s'>&quot;true&quot;</span><span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>
				<span class='k'>print</span> <span class='s'>&quot;notification shown for&quot;</span><span class='p'>,</span> <span class='n'>name</span>

			<span class='k'>print</span> <span class='s'>&quot;</span><span class='si'>%d</span><span class='s'> messages from </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>],</span><span class='n'>name</span><span class='p'>)</span>
		<span class='c'># Set oldcountt variable for next loop</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span>
		<span class='c'># Loop runs as long as true is returned</span>
		<span class='k'>return</span> <span class='bp'>True</span>
</code></pre></div>
<p>When a new messages arrives, this is what the messaging menu looks like <a href='http://jfoucher.com/uploads/2011/01/skype-indicator-menu.png'><img src='http://jfoucher.com/uploads/2011/01/skype-indicator-menu.png' title='skype-indicator-menu' width='376' alt='Messaging menu open qith unread messages' class='aligncenter size-full wp-image-258' height='256' /></a></p>

<p>The function that gets unread skype messages is as follows For each message, we add it to a list containg the messages from a particular user in the self.unread dictionary.</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>get_messages</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='k'>print</span> <span class='s'>&quot;checking messages&quot;</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='o'>=</span><span class='p'>{}</span>

		<span class='k'>for</span> <span class='n'>msg</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>MissedMessages</span><span class='p'>:</span>
			<span class='n'>display_name</span> <span class='o'>=</span> <span class='n'>msg</span><span class='o'>.</span><span class='n'>FromHandle</span>
			<span class='k'>if</span> <span class='n'>display_name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>=</span><span class='mi'>0</span>
			<span class='k'>if</span> <span class='ow'>not</span> <span class='n'>display_name</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>=</span><span class='p'>[]</span>
			
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>)</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>+=</span><span class='mi'>1</span>
		<span class='k'>return</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span>
</code></pre></div>
<p>The next two functions are in charge of getting the skype user username as well as the friendliest name available.</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>name_from_handle</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span><span class='n'>handle</span><span class='p'>):</span>
		<span class='n'>user</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>User</span><span class='p'>(</span><span class='n'>handle</span><span class='p'>)</span>
		<span class='k'>if</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>FullName</span><span class='p'>:</span>
			<span class='k'>return</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>FullName</span>
		<span class='k'>elif</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>DisplayName</span><span class='p'>:</span>
			<span class='k'>return</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>DisplayName</span>
		<span class='k'>else</span><span class='p'>:</span>
			<span class='k'>return</span> <span class='n'>handle</span>

	<span class='k'>def</span> <span class='nf'>user_from_handle</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span><span class='n'>handle</span><span class='p'>):</span>
		<span class='k'>return</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>User</span><span class='p'>(</span><span class='n'>handle</span><span class='p'>)</span>
</code></pre></div>
<p>Below is the generic function in charge of showing popup notifications.</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>showNotification</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>title</span><span class='p'>,</span> <span class='n'>message</span><span class='p'>,</span><span class='nb'>file</span><span class='o'>=</span><span class='bp'>None</span><span class='p'>):</span>
		<span class='sd'>&#39;&#39;&#39;takes a title and a message to display the email notification. Returns the</span>
<span class='sd'>        created notification object&#39;&#39;&#39;</span>

		<span class='n'>n</span> <span class='o'>=</span> <span class='n'>pynotify</span><span class='o'>.</span><span class='n'>Notification</span><span class='p'>(</span><span class='n'>title</span><span class='p'>,</span> <span class='n'>message</span><span class='p'>,</span> <span class='s'>&quot;notification-message-im&quot;</span><span class='p'>)</span>
		<span class='k'>if</span> <span class='nb'>file</span> <span class='ow'>is</span> <span class='ow'>not</span> <span class='bp'>None</span><span class='p'>:</span>
			<span class='n'>n</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;icon-name&quot;</span><span class='p'>,</span><span class='n'>os</span><span class='o'>.</span><span class='n'>getcwd</span><span class='p'>()</span> <span class='o'>+</span> <span class='s'>&quot;/&quot;</span> <span class='o'>+</span> <span class='nb'>file</span><span class='p'>)</span>
		<span class='n'>n</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>

		<span class='k'>return</span> <span class='n'>n</span>
</code></pre></div>
<p>This is what it looks like with three new messages <a href='http://jfoucher.com/uploads/2011/01/skype-indicator.png'><img src='http://jfoucher.com/uploads/2011/01/skype-indicator.png' title='skype-indicator' width='428' alt='The Ubuntu skype indicator with three new messages' class='aligncenter size-full wp-image-253' height='232' /></a></p>

<p>The next one shows the popup notification that skype is not loaded :</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>noSkype</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='sd'>&#39;&#39;&#39;Shows a notification if skype is not started&#39;&#39;&#39;</span>
		<span class='n'>title</span><span class='o'>=</span><span class='s'>&#39;Start Skype&#39;</span>
		<span class='n'>message</span><span class='o'>=</span><span class='s'>&#39;Please start skype otherwise this won</span><span class='se'>\&#39;</span><span class='s'>t work&#39;</span>
		<span class='n'>n</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>showNotification</span><span class='p'>(</span><span class='n'>title</span><span class='p'>,</span> <span class='n'>message</span><span class='p'>)</span>
		<span class='n'>n</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;icon-name&quot;</span><span class='p'>,</span><span class='n'>gtk</span><span class='o'>.</span><span class='n'>STOCK_DIALOG_WARNING</span><span class='p'>)</span>
		<span class='n'>n</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>

		<span class='k'>return</span> <span class='n'>n</span>
</code></pre></div>
<p>And finally, the indicator events callbacks (what happens when we click on the skype indicator, or on a particular message</p>
<div class='highlight'><pre><code class='python'>	<span class='k'>def</span> <span class='nf'>display_msg</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>indicator</span><span class='p'>,</span> <span class='n'>timestamp</span><span class='p'>):</span>
		<span class='c'>#hide this indicator</span>
		<span class='n'>indicator</span><span class='o'>.</span><span class='n'>hide</span><span class='p'>()</span>
		<span class='c'>#messaging menu goes back to normal</span>
		<span class='n'>indicator</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;draw-attention&quot;</span><span class='p'>,</span> <span class='s'>&quot;false&quot;</span><span class='p'>)</span>
		<span class='c'># open the skype chat window for this user</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>OpenMessageDialog</span><span class='p'>(</span><span class='n'>indicator</span><span class='o'>.</span><span class='n'>get_property</span><span class='p'>(</span><span class='s'>&quot;handle&quot;</span><span class='p'>))</span>
</code></pre></div>
<p>At the end of the file, we start everything :</p>
<div class='highlight'><pre><code class='python'><span class='k'>if</span> <span class='n'>__name__</span> <span class='o'>==</span> <span class='s'>&quot;__main__&quot;</span><span class='p'>:</span>
	<span class='n'>skypeind</span><span class='o'>=</span><span class='n'>skypeIndicator</span><span class='p'>()</span>
	<span class='c'># Loop</span>
	<span class='n'>gobject</span><span class='o'>.</span><span class='n'>timeout_add_seconds</span><span class='p'>(</span><span class='mi'>5</span><span class='p'>,</span> <span class='n'>skypeind</span><span class='o'>.</span><span class='n'>create_indicators</span><span class='p'>)</span>
	<span class='n'>gtk</span><span class='o'>.</span><span class='n'>main</span><span class='p'>()</span>
</code></pre></div>
<p>And finally, here is the complete source code :</p>
<div class='highlight'><pre><code class='python'><span class='c'>#!/usr/bin/env python</span>
<span class='c'>#</span>
<span class='c'>#Copyright 2010 Jonathan Foucher</span>
<span class='c'>#</span>
<span class='c'>#Authors:</span>
<span class='c'>#    Jonathan Foucher &lt;jfoucher@6px.eu&gt;</span>
<span class='c'>#</span>
<span class='c'>#This program is free software: you can redistribute it and/or modify it </span>
<span class='c'>#under the terms of either or both of the following licenses:</span>
<span class='c'>#</span>
<span class='c'>#1) the GNU Lesser General Public License version 3, as published by the </span>
<span class='c'>#Free Software Foundation; and/or</span>
<span class='c'>#2) the GNU Lesser General Public License version 2.1, as published by </span>
<span class='c'>#the Free Software Foundation.</span>
<span class='c'>#</span>
<span class='c'>#This program is distributed in the hope that it will be useful, but </span>
<span class='c'>#WITHOUT ANY WARRANTY; without even the implied warranties of </span>
<span class='c'>#MERCHANTABILITY, SATISFACTORY QUALITY or FITNESS FOR A PARTICULAR </span>
<span class='c'>#PURPOSE.  See the applicable version of the GNU Lesser General Public </span>
<span class='c'>#License for more details.</span>
<span class='c'>#</span>
<span class='c'>#You should have received a copy of both the GNU Lesser General Public </span>
<span class='c'>#License version 3 and version 2.1 along with this program.  If not, see </span>
<span class='c'>#&lt;http://www.gnu.org/licenses/&gt;</span>
<span class='c'>#</span>


<span class='kn'>import</span> <span class='nn'>indicate</span>
<span class='kn'>import</span> <span class='nn'>gobject</span>
<span class='kn'>import</span> <span class='nn'>pynotify</span>
<span class='kn'>import</span> <span class='nn'>gtk</span>
<span class='kn'>import</span> <span class='nn'>hashlib</span>
<span class='kn'>import</span> <span class='nn'>Skype4Py</span>
<span class='kn'>import</span> <span class='nn'>urllib</span>
<span class='kn'>import</span> <span class='nn'>os</span>


<span class='k'>class</span> <span class='nc'>skypeIndicator</span><span class='p'>:</span>
	<span class='n'>notifShown</span><span class='o'>=</span><span class='p'>{}</span>
	<span class='n'>oldcount</span><span class='o'>=</span><span class='p'>{}</span>
	<span class='n'>count</span><span class='o'>=</span><span class='p'>{}</span>
	<span class='n'>indicator</span><span class='o'>=</span><span class='p'>{}</span>

	<span class='k'>def</span> <span class='nf'>__init__</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='c'>#self.no_skype()</span>
		<span class='c'>#get skype control</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>=</span> <span class='n'>Skype4Py</span><span class='o'>.</span><span class='n'>Skype</span><span class='p'>()</span>
		
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>loadSkype</span><span class='p'>()</span>

		<span class='c'>#create notification icon</span>

		<span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span> <span class='o'>=</span> <span class='n'>indicate</span><span class='o'>.</span><span class='n'>indicate_server_ref_default</span><span class='p'>()</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>set_type</span><span class='p'>(</span><span class='s'>&quot;message.im&quot;</span><span class='p'>)</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>set_desktop_file</span><span class='p'>(</span><span class='s'>&quot;/usr/share/applications/skype.desktop&quot;</span><span class='p'>)</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>connect</span><span class='p'>(</span><span class='s'>&quot;server-display&quot;</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>server_display</span><span class='p'>)</span>
		<span class='c'>#self.server.set_status (indicate.STATUS_ACTIVE)</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>server</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>
<span class='c'>#		for slot in dir(self.server):</span>
<span class='c'>#			attr = getattr(self.server, slot)</span>
<span class='c'>#			print attr</span>

		<span class='c'>#self.unread={}</span>
		<span class='c'>#self.indicator.set_property(&#39;draw-attention&#39;, &#39;true&#39;);</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>create_indicators</span><span class='p'>()</span>
		<span class='c'>#pass</span>
		<span class='c'>#indicator.connect(&quot;user-display&quot;, self.display_msg)</span>
	<span class='k'>def</span> <span class='nf'>loadSkype</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='k'>try</span><span class='p'>:</span>
			<span class='k'>if</span> <span class='ow'>not</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>IsRunning</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>Start</span><span class='p'>()</span>
		<span class='k'>except</span><span class='p'>:</span>
			<span class='c'>#</span>
			<span class='k'>print</span> <span class='s'>&quot;Please open skype first&quot;</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>noSkype</span><span class='p'>()</span>



		<span class='k'>try</span><span class='p'>:</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Attach</span><span class='p'>()</span>
		<span class='k'>except</span> <span class='n'>Skype4Py</span><span class='o'>.</span><span class='n'>errors</span><span class='o'>.</span><span class='n'>ISkypeAPIError</span><span class='p'>:</span>
			<span class='k'>print</span> <span class='s'>&quot;Please open skype first&quot;</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>noSkype</span><span class='p'>()</span>
			<span class='c'>#pass</span>

	<span class='k'>def</span> <span class='nf'>create_indicators</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>

		<span class='sd'>&quot;&quot;&quot;Loads skype messages, displays them as notification bubbles and also shows them in the messaging menu&quot;&quot;&quot;</span>

		<span class='c'>#initialize count dictionaries</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='o'>=</span><span class='p'>{}</span>
		<span class='c'>#get unread messages from skype, set self.unread variable</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>get_messages</span><span class='p'>()</span>

		<span class='c'>#self.unread is a dictionary having the username of the sender as key and a list of messages as value</span>
		<span class='k'>for</span> <span class='n'>name</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>:</span>

			<span class='c'># Here we look at the first message from this user to set the messaging menu indicator</span>
			<span class='c'># we only want one indicator per user</span>
			<span class='n'>msg</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>name</span><span class='p'>][</span><span class='mi'>0</span><span class='p'>]</span>

			<span class='c'>#initialize message count for this user</span>
			<span class='k'>if</span> <span class='n'>name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='mi'>0</span>
			<span class='k'>if</span> <span class='n'>name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='mi'>0</span>

			<span class='c'># if this user doesn&#39;t have his indicator yet</span>
			<span class='k'>if</span> <span class='n'>name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>:</span>
				<span class='c'># create indicator</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span> <span class='o'>=</span> <span class='n'>indicate</span><span class='o'>.</span><span class='n'>Indicator</span><span class='p'>()</span>
				<span class='k'>print</span> <span class='s'>&quot;creating indicator&quot;</span>

				<span class='c'># Set indicator properties</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>fullname</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>name_from_handle</span><span class='p'>(</span><span class='n'>name</span><span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;subtype&quot;</span><span class='p'>,</span> <span class='s'>&quot;im&quot;</span><span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;sender&quot;</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>fullname</span> <span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;handle&quot;</span><span class='p'>,</span> <span class='n'>name</span><span class='p'>)</span>

				<span class='c'>#this gets the most user-friendly name available for this user</span>
				<span class='n'>user</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>user_from_handle</span><span class='p'>(</span><span class='n'>name</span><span class='p'>)</span>

				<span class='c'># get an avatar for this user</span>
				<span class='k'>try</span><span class='p'>:</span>
					<span class='c'># This will only work on windows</span>
					<span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='o'>=</span><span class='n'>name</span> <span class='o'>+</span> <span class='s'>&#39;.jpg&#39;</span>
					<span class='n'>user</span><span class='o'>.</span><span class='n'>SaveAvatarToFile</span><span class='p'>(</span><span class='nb'>file</span><span class='p'>)</span>
				<span class='k'>except</span> <span class='n'>Skype4Py</span><span class='o'>.</span><span class='n'>errors</span><span class='o'>.</span><span class='n'>ISkypeError</span><span class='p'>:</span>
					<span class='c'># So on linux we use a generated monster ID. Fun but useless!</span>
					<span class='n'>h</span><span class='o'>=</span><span class='n'>hashlib</span><span class='o'>.</span><span class='n'>md5</span><span class='p'>(</span><span class='n'>name</span><span class='p'>)</span><span class='o'>.</span><span class='n'>hexdigest</span><span class='p'>()</span>
					<span class='c'>#TODO find a way to get skype avatars on linux</span>
					<span class='n'>urllib</span><span class='o'>.</span><span class='n'>urlretrieve</span><span class='p'>(</span><span class='s'>&#39;http://friedcellcollective.net/monsterid/monster/</span><span class='si'>%s</span><span class='s'>/64&#39;</span> <span class='o'>%</span> <span class='n'>h</span><span class='p'>,</span><span class='n'>name</span> <span class='o'>+</span> <span class='s'>&#39;.jpg&#39;</span><span class='p'>)</span>
					<span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='o'>=</span><span class='n'>name</span> <span class='o'>+</span> <span class='s'>&#39;.jpg&#39;</span>

				<span class='c'>#convert the imge to a pixbuf</span>
				<span class='n'>pixbuf</span><span class='o'>=</span><span class='n'>gtk</span><span class='o'>.</span><span class='n'>gdk</span><span class='o'>.</span><span class='n'>pixbuf_new_from_file</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='p'>)</span>
				<span class='c'># for use in the indicator</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property_icon</span><span class='p'>(</span><span class='s'>&quot;icon&quot;</span><span class='p'>,</span> <span class='n'>pixbuf</span><span class='p'>)</span>

				<span class='c'># set the timestamp of the indicator (this is what makes the indicator display the time since the message was received</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property_time</span><span class='p'>(</span><span class='s'>&quot;time&quot;</span><span class='p'>,</span> <span class='n'>msg</span><span class='o'>.</span><span class='n'>Timestamp</span><span class='p'>)</span>

				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>
				<span class='c'># when the user clicks on the indicator message, open the skype messaging window for this user</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>connect</span><span class='p'>(</span><span class='s'>&quot;user-display&quot;</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>display_msg</span><span class='p'>)</span>
				
			<span class='n'>msgbody</span> <span class='o'>=</span> <span class='s'>&#39;&#39;</span>
			<span class='c'>#reverse list so latest message is at the bottom</span>
			<span class='k'>for</span> <span class='n'>eachmsg</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>name</span><span class='p'>][::</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>]:</span>
				<span class='c'># msgbody contains all the messages from that user so far</span>
				<span class='n'>msgbody</span> <span class='o'>+=</span> <span class='n'>eachmsg</span><span class='o'>.</span><span class='n'>Body</span> <span class='o'>+</span> <span class='s'>&quot;</span><span class='se'>\n</span><span class='s'>&quot;</span>

			<span class='c'># We set this person&#39;s indicator body to the compound text</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;body&quot;</span><span class='p'>,</span> <span class='n'>msgbody</span><span class='p'>)</span>

			<span class='c'># if there are more than one message from this user, we set the indicator count to be displayed in the messaging menu.</span>
			<span class='c'># Otherwise the time elapsed since receiving the message will be shown</span>
			<span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span> <span class='o'>&gt;</span> <span class='mi'>1</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;count&quot;</span><span class='p'>,</span> <span class='nb'>str</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]))</span>
			
			<span class='c'># If a new message arrived since last time checked, mark notification as not shown</span>
			<span class='k'>if</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span> <span class='o'>&gt;</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>notifShown</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='bp'>False</span>

			<span class='c'>#If notification marked as not shown, show it</span>
			<span class='k'>if</span> <span class='ow'>not</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>notifShown</span><span class='o'>.</span><span class='n'>get</span><span class='p'>(</span><span class='n'>name</span><span class='p'>,</span> <span class='bp'>False</span><span class='p'>)</span> <span class='ow'>and</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>showNotification</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>fullname</span><span class='p'>,</span> <span class='n'>msgbody</span><span class='p'>,</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>file</span><span class='p'>):</span>
				<span class='c'>#mark notification as shown</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>notifShown</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>=</span><span class='bp'>True</span>

				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;draw-attention&quot;</span><span class='p'>,</span> <span class='s'>&quot;true&quot;</span><span class='p'>)</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>indicator</span><span class='p'>[</span><span class='n'>name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>
				<span class='k'>print</span> <span class='s'>&quot;notification shown for&quot;</span><span class='p'>,</span> <span class='n'>name</span>

			<span class='k'>print</span> <span class='s'>&quot;</span><span class='si'>%d</span><span class='s'> messages from </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>name</span><span class='p'>],</span><span class='n'>name</span><span class='p'>)</span>
		<span class='c'># Set oldcountt variable for next loop</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>oldcount</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span>
		<span class='c'># Loop runs as long as true is returned</span>
		<span class='k'>return</span> <span class='bp'>True</span>


	<span class='k'>def</span> <span class='nf'>name_from_handle</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span><span class='n'>handle</span><span class='p'>):</span>
		<span class='n'>user</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>User</span><span class='p'>(</span><span class='n'>handle</span><span class='p'>)</span>
		<span class='k'>if</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>FullName</span><span class='p'>:</span>
			<span class='k'>return</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>FullName</span>
		<span class='k'>elif</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>DisplayName</span><span class='p'>:</span>
			<span class='k'>return</span> <span class='n'>user</span><span class='o'>.</span><span class='n'>DisplayName</span>
		<span class='k'>else</span><span class='p'>:</span>
			<span class='k'>return</span> <span class='n'>handle</span>

	<span class='k'>def</span> <span class='nf'>user_from_handle</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span><span class='n'>handle</span><span class='p'>):</span>
		<span class='k'>return</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>User</span><span class='p'>(</span><span class='n'>handle</span><span class='p'>)</span>

	<span class='k'>def</span> <span class='nf'>showNotification</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>title</span><span class='p'>,</span> <span class='n'>message</span><span class='p'>,</span><span class='nb'>file</span><span class='o'>=</span><span class='bp'>None</span><span class='p'>):</span>
		<span class='sd'>&#39;&#39;&#39;takes a title and a message to display the email notification. Returns the</span>
<span class='sd'>        created notification object&#39;&#39;&#39;</span>

		<span class='n'>n</span> <span class='o'>=</span> <span class='n'>pynotify</span><span class='o'>.</span><span class='n'>Notification</span><span class='p'>(</span><span class='n'>title</span><span class='p'>,</span> <span class='n'>message</span><span class='p'>,</span> <span class='s'>&quot;notification-message-im&quot;</span><span class='p'>)</span>
		<span class='k'>if</span> <span class='nb'>file</span> <span class='ow'>is</span> <span class='ow'>not</span> <span class='bp'>None</span><span class='p'>:</span>
			<span class='n'>n</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;icon-name&quot;</span><span class='p'>,</span><span class='n'>os</span><span class='o'>.</span><span class='n'>getcwd</span><span class='p'>()</span> <span class='o'>+</span> <span class='s'>&quot;/&quot;</span> <span class='o'>+</span> <span class='nb'>file</span><span class='p'>)</span>
		<span class='n'>n</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>

		<span class='k'>return</span> <span class='n'>n</span>

	<span class='k'>def</span> <span class='nf'>noSkype</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='sd'>&#39;&#39;&#39;Shows a notification if skype is not started&#39;&#39;&#39;</span>
		<span class='n'>title</span><span class='o'>=</span><span class='s'>&#39;Start Skype&#39;</span>
		<span class='n'>message</span><span class='o'>=</span><span class='s'>&#39;Please start skype otherwise this won</span><span class='se'>\&#39;</span><span class='s'>t work&#39;</span>
		<span class='n'>n</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>showNotification</span><span class='p'>(</span><span class='n'>title</span><span class='p'>,</span> <span class='n'>message</span><span class='p'>)</span>
		<span class='n'>n</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;icon-name&quot;</span><span class='p'>,</span><span class='n'>gtk</span><span class='o'>.</span><span class='n'>STOCK_DIALOG_WARNING</span><span class='p'>)</span>
		<span class='n'>n</span><span class='o'>.</span><span class='n'>show</span><span class='p'>()</span>

		<span class='k'>return</span> <span class='n'>n</span>

	<span class='k'>def</span> <span class='nf'>get_messages</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
		<span class='k'>print</span> <span class='s'>&quot;checking messages&quot;</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='o'>=</span><span class='p'>{}</span>

		<span class='k'>for</span> <span class='n'>msg</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>MissedMessages</span><span class='p'>:</span>
			<span class='n'>display_name</span> <span class='o'>=</span> <span class='n'>msg</span><span class='o'>.</span><span class='n'>FromHandle</span>
			<span class='k'>if</span> <span class='n'>display_name</span> <span class='ow'>not</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>=</span><span class='mi'>0</span>
			<span class='k'>if</span> <span class='ow'>not</span> <span class='n'>display_name</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>:</span>
				<span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>=</span><span class='p'>[]</span>
			
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>)</span>
			<span class='bp'>self</span><span class='o'>.</span><span class='n'>count</span><span class='p'>[</span><span class='n'>display_name</span><span class='p'>]</span><span class='o'>+=</span><span class='mi'>1</span>
		<span class='k'>return</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>unread</span>



	<span class='k'>def</span> <span class='nf'>server_display</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>widget</span><span class='p'>,</span> <span class='n'>timestamp</span><span class='o'>=</span><span class='bp'>None</span><span class='p'>):</span>
		<span class='c'>#Show main Skype window</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>Focus</span><span class='p'>()</span>

	<span class='k'>def</span> <span class='nf'>display_msg</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>indicator</span><span class='p'>,</span> <span class='n'>timestamp</span><span class='p'>):</span>
		<span class='c'>#hide this indicator</span>
		<span class='n'>indicator</span><span class='o'>.</span><span class='n'>hide</span><span class='p'>()</span>
		<span class='c'>#messaging menu goes back to normal</span>
		<span class='n'>indicator</span><span class='o'>.</span><span class='n'>set_property</span><span class='p'>(</span><span class='s'>&quot;draw-attention&quot;</span><span class='p'>,</span> <span class='s'>&quot;false&quot;</span><span class='p'>)</span>
		<span class='c'># open the skype chat window for this user</span>
		<span class='bp'>self</span><span class='o'>.</span><span class='n'>skype</span><span class='o'>.</span><span class='n'>Client</span><span class='o'>.</span><span class='n'>OpenMessageDialog</span><span class='p'>(</span><span class='n'>indicator</span><span class='o'>.</span><span class='n'>get_property</span><span class='p'>(</span><span class='s'>&quot;handle&quot;</span><span class='p'>))</span>



<span class='k'>if</span> <span class='n'>__name__</span> <span class='o'>==</span> <span class='s'>&quot;__main__&quot;</span><span class='p'>:</span>

	<span class='n'>skypeind</span><span class='o'>=</span><span class='n'>skypeIndicator</span><span class='p'>()</span>

	<span class='c'># Loop</span>
	<span class='n'>gobject</span><span class='o'>.</span><span class='n'>timeout_add_seconds</span><span class='p'>(</span><span class='mi'>5</span><span class='p'>,</span> <span class='n'>skypeind</span><span class='o'>.</span><span class='n'>create_indicators</span><span class='p'>)</span>
	<span class='n'>gtk</span><span class='o'>.</span><span class='n'>main</span><span class='p'>()</span>
</code></pre></div>
<p>Download the script, or fork it on the <a href='https://github.com/jfoucher/ubuntu-skype-indicator'>ubuntu-skype-indicator github repository</a></p>

<p>UPDATE: Before you run this script, you need to install its dependencies, python-indicate and skype4py On ubuntu, it&#8217;s as simple as running <div class='highlight'><pre><code class='bash'>sudo apt-get install python-skype python-indicate
</code></pre></div></p>



                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'geekynuggets'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            </div> <!-- /.entry-content.colEight -->
            <div class="page-nav-bottom">
                
				    <span class="page-nav-item page-prev"><a class="internal" rel="prev"  href="/2011/01/compile-custom-kernel-on-ubuntu-10-10.html#notebook" title="Read Compile custom kernel on Ubuntu 10.10">&larr; View previous article</a></span>
				
				
				    <span class="page-nav-item page-next"><a class="internal" rel="next"  href="/2011/01/spanish-characters-on-qwerty-keyboard-for-ubuntu-10-10.html#notebook" title="Read Spanish characters on Qwerty keyboard for Ubuntu 10.10">View next article &rarr;</a></span>
                
            </div> <!-- /.page-nav-bottom -->
        </div> <!-- /#notebook.center.clear -->
            <footer id="footer" class="clear">
        <span class="backtop"><a class="internal" href="#header" title="Return to the top of this page">Back to top &uarr;</a></span>
        <nav>
            <ul id="nav-footer">
                <li><a href="/about.html" title="About &amp; contact information" tabindex="0">About <span class="amp">&amp;</span> Contact</a></li>
                <li><a href="/archives.html" title="View the blog archives" tabindex="0">Archives</a></li>

                <li><a href="http://feeds.feedburner.com/GeekyNuggets" title="Feed link" tabindex="0">Feed</a></li>
            </ul>
        </nav>

        <div class="page-meta clear">
            <div class="info">

                <p class="copyright ">
                    This blog has been online in one form or another since
                    <span class="date" title="March 2004">2004</span><br />Copyright &copy; <a href="http://jfoucher.com">Jonathan
                    Foucher.</a><br /><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"
                       title="You can use this for non-comercial purposes, provided you cite me as the author, and do not modify the content">
                        Creative Commons License
                    </a>
                    <br />
                    <a href="/jfoucher-6px.eu.asc">GPG Key</a>
                </p>
            </div>

        </div> <!-- /.page-meta.clear -->
    </footer> <!-- /#footer.center.clear -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8465441-2']);
    _gaq.push(['_trackPageview']);



    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
        '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();


    var docHeight = document.height,
    vscroll = $(document).scrollTop();

    $(document).bind('scroll', function(){
        var docHeight = document.height,
                vscroll = $(document).scrollTop();

        if(vscroll > docHeight / 2) {
            $(document).unbind('scroll');
            _gaq.push(['_trackEvent', 'scrolled_half', 'read']);
            console.log('not a bounce')
        }
    });

    </script>

    <script type="text/javascript">
        var clicky_site_ids = clicky_site_ids || [];
        clicky_site_ids.push(100617617);
        (function() {
            var s = document.createElement('script');
            s.type = 'text/javascript';
            s.async = true;
            s.src = '//static.getclicky.com/js';
            ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
        })();
    </script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100617617ns.gif" /></p></noscript>
</body>
</html>
	</div>
